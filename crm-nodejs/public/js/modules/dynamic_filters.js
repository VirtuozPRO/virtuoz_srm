// ============================================================================
// Р”РРќРђРњРР§Р•РЎРљРР• Р¤РР›Р¬РўР Р« CRM Р’Р•Р РўРЈРњ
// РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃРіРµРЅРµСЂРёСЂРѕРІР°РЅРѕ РёР· Excel С„Р°Р№Р»Р°
// Р›РёСЃС‚ РґР°РЅРЅС‹С…: Р›РёСЃС‚1
// Р’СЂРµРјСЏ РіРµРЅРµСЂР°С†РёРё: 2026-02-05 15:01:25
// ============================================================================

// Р“Р»РѕР±Р°Р»СЊРЅС‹Рµ РЅР°СЃС‚СЂРѕР№РєРё С„РёР»СЊС‚СЂРѕРІ
const CRM_FILTERS = {
    version: '1.0',
    sheetName: 'Р›РёСЃС‚1',
    filters: {
    "РљРѕРґ": [
        "014XX",
        "015XX",
        "035XX",
        "047XX",
        "048XX",
        "075XX",
        "076XX",
        "102XX",
        "113XX",
        "118XX",
        "129XX",
        "130XX",
        "132XX",
        "152XX",
        "162XX",
        "166XX",
        "168XX",
        "170XX",
        "171XX",
        "172XX",
        "181XX",
        "182XX",
        "185XX",
        "186XX",
        "187XX",
        "190XX",
        "192XX",
        "195XX",
        "196XX",
        "197XX",
        "201XX",
        "202XX",
        "204XX",
        "205XX",
        "217XX",
        "221XX",
        "226XX",
        "233XX",
        "237XX",
        "240XX",
        "245XX",
        "249XX",
        "250XX",
        "254XX",
        "262XX",
        "263XX",
        "268XX",
        "273XX",
        "276XX",
        "279XX",
        "280XX",
        "297XX",
        "309XX",
        "310XX",
        "318XX",
        "350XX",
        "353XX",
        "357XX",
        "358XX",
        "359XX",
        "360XX",
        "369XX",
        "378XX",
        "397XX",
        "411XX",
        "454XX",
        "456XX",
        "464XX",
        "469XX",
        "474XX",
        "486XX",
        "487XX",
        "494XX",
        "500XX",
        "678XX",
        "694XX",
        "699XX",
        "717XX",
        "724XX",
        "732XX",
        "733XX",
        "735XX",
        "744XX",
        "751XX",
        "754XX",
        "765XX",
        "766XX",
        "776XX",
        "777XX",
        "779XX",
        "780XX",
        "781XX",
        "783XX",
        "784XX",
        "785XX",
        "790XX",
        "799XX",
        "800XX",
        "801XX"
    ],
    "РЎРµРіРјРµРЅС‚Р°С†РёСЏ РљР‘": [
        "1.1 РўРћРџ РґРѕ Р¦РљРђР” (РІСЃРµ)",
        "1.3 РўРћРџ Р·Р° Р¦РљРђР” (РІСЃРµ)",
        "1.5 РРЅРґРёРІРёРґ. СѓСЃР»РѕРІРёСЏ РўРћРџ Р·Р° Р¦РљРђР”",
        "1.6 РџРѕРїСѓС‚РЅР°СЏ РґРѕСЃС‚Р°РІРєР° РўРћРџ РґРѕ Р¦РљРђР” (РІСЃРµ)",
        "1.7 РџРѕРїСѓС‚РЅР°СЏ РґРѕСЃС‚Р°РІРєР° РўРћРџ Р·Р° Р¦РљРђР” (РІСЃРµ)",
        "2.1 РЎС‚Р°РЅРґР°СЂС‚ РґРѕ Р¦РљРђР” (РІСЃРµ)",
        "2.2 РЎС‚Р°РЅРґР°СЂС‚ РґРѕ Р¦РљРђР” (СЃР°РЅС‚РµС… Рё РІРµРЅС‚)",
        "2.3 РЎС‚Р°РЅРґР°СЂС‚ Р·Р° Р¦РљРђР” (РІСЃРµ)",
        "2.4 РЎС‚Р°РЅРґР°СЂС‚ Р·Р° Р¦РљРђР” (РЎР°РЅС‚РµС… Рё РІРµРЅС‚)",
        "2.5 РџРѕРїСѓС‚РЅР°СЏ РґРѕСЃС‚Р°РІРєР° РЎС‚Р°РЅРґР°СЂС‚ РґРѕ Р¦РљРђР” (РІСЃРµ)",
        "2.6 РџРѕРїСѓС‚РЅР°СЏ РґРѕСЃС‚Р°РІРєР° РЎС‚Р°РЅРґР°СЂС‚ Р·Р° Р¦РљРђР” (РІСЃРµ)"
    ],
    "Р‘РёР·РЅРµСЃ-СЂРµРіРёРѕРЅ": [
        "Р‘РѕСЂРѕРІСЃРєРёР№ СЂ-РЅ РљРћ",
        "Р”РѕРјРѕРґРµРґРѕРІРѕ Рі.Рѕ.",
        "Р—Р°РѕРєСЃРєРёР№ СЂ-РЅ",
        "РСЃС‚СЂР° Рі.Рѕ.",
        "РљР°С€РёСЂР° Рі.Рѕ.",
        "РљР»РёРЅ Рі.Рѕ.",
        "РљСЂР°СЃРЅРѕРіРѕСЂСЃРє Рі.Рѕ.",
        "Р›РµРЅРёРЅСЃРєРёР№ Рі.Рѕ.",
        "РњРѕР¶Р°Р№СЃРєРёР№ Рі.Рѕ.",
        "РќР°СЂРѕ-Р¤РѕРјРёРЅСЃРєРёР№ Рі.Рѕ.",
        "РќРѕРІРѕРјРѕСЃРєРѕРІСЃРєРёР№ РђРћ",
        "РћР±РЅРёРЅСЃРє РљРћ",
        "РћРґРёРЅС†РѕРІСЃРєРёР№ Рі.Рѕ.",
        "РџРѕРґРѕР»СЊСЃРє Рі.Рѕ.",
        "Р Р°РјРµРЅСЃРєРёР№ Рі.Рѕ.",
        "Р СѓР·СЃРєРёР№ Рі.Рѕ.",
        "РЎРµСЂРїСѓС…РѕРІ Рі.Рѕ.",
        "РЎРѕР»РЅРµС‡РЅРѕРіРѕСЂСЃРє Рі.Рѕ.",
        "РўСЂРѕРёС†РєРёР№ РђРћ",
        "РўСѓР»Р°",
        "РҐРёРјРєРё Рі.Рѕ.",
        "Р§РµС…РѕРІ Рі.Рѕ.",
        "РЁР°С…РѕРІСЃРєР°СЏ Рі.Рѕ.",
        "Р®Р¶РЅС‹Р№ РђРћ"
    ],
    "Р’РёРґ Р±РёР·РЅРµСЃР°": [
        "DIY (Р”Рћ)",
        "Р”РёСЃС‚СЂРёР±СѓС‚РѕСЂ Р”Рћ",
        "РРЅС‚РµСЂРЅРµС‚ РњР°РіР°Р·РёРЅ (Р”Рћ)",
        "РџСЂРѕРёР·РІРѕРґРёС‚РµР»СЊ (Р”Рћ)",
        "Р РѕР·РЅРёС‡РЅР°СЏ РЎРµС‚СЊ (Р”Рћ)",
        "Р РѕР·РЅРёС‡РЅС‹Р№ РњР°РіР°Р·РёРЅ (Р”Рћ)",
        "РЎС‚СЂРѕРёС‚РµР»СЊ (Р”Рћ)",
        "РЎС‚СЂРѕРёС‚РµР»СЊРЅР°СЏ Р‘Р°Р·Р° (Р”Рћ)",
        "РЎС‚СЂРѕРёС‚РµР»СЊРЅР°СЏ РћСЂРіР°РЅРёР·Р°С†РёСЏ (Р”Рћ)"
    ],
    "РўРѕРІР°СЂРЅР°СЏ РіСЂСѓРїРїР°": [
        "Р’РµРЅС‚РёР»СЏС†РёСЏ Р”Рћ",
        "РљСЂРѕРІР»СЏ Р”Рћ",
        "РљСЂРѕРІР»СЏ Рё Р”СЂРµРЅР°Р¶ Р”Рћ",
        "РљСЂРѕРІР»СЏ Рё Р¤Р°СЃР°РґС‹ Р”Рћ",
        "РћР±С‰РµСЃС‚СЂРѕР№ Р”Рћ",
        "РЎР°РЅС‚РµС…РЅРёРєР° Р”Рћ",
        "Р¤Р°СЃР°Рґ Р”Рћ"
    ],
    "Р—РѕРЅР°": [
        "РљР°Р»СѓР¶СЃРєРѕРµ С€.",
        "РљР°С€РёСЂСЃРєРѕРµ С€.",
        "РљРёРµРІСЃРєРѕРµ С€.",
        "Р›РµРЅРёРЅРіСЂР°РґСЃРєРѕРµ С€.",
        "РњРёРЅСЃРєРѕРµ С€.",
        "РќРѕРІРѕСЂРёР¶СЃРєРѕРµ С€.",
        "Р СЏР·Р°РЅСЃРєРѕРµ С€.",
        "РЎРёРјС„РµСЂРѕРїРѕР»СЊСЃРєРѕРµ С€."
    ],
    "РќР°РїСЂР°РІР»РµРЅРёРµ": [
        "РљР°Р»СѓР¶СЃРєРѕРµ С€.",
        "РљР°С€РёСЂСЃРєРѕРµ С€.",
        "РљРёРµРІСЃРєРѕРµ С€.",
        "Р›РµРЅРёРЅРіСЂР°РґСЃРєРѕРµ С€.",
        "РњРёРЅСЃРєРѕРµ С€.",
        "РќРѕРІРѕСЂРёР¶СЃРєРѕРµ С€.",
        "Р СЏР·Р°РЅСЃРєРѕРµ С€.",
        "РЎРёРјС„РµСЂРѕРїРѕР»СЊСЃРєРѕРµ С€."
    ],
    "РђРґСЂРµСЃ": [
        "РђР»РµСЂРµСЏ",
        "РђСЂС„РµРЅРєРё",
        "Р‘Р°Р±РєРёРЅРѕ",
        "Р‘СѓР¶Р°СЂРѕРІРѕ",
        "Р”РѕРјРѕРґРµРґРѕРІРѕ",
        "Р”РѕСЂРѕС…РѕРІРѕ",
        "Р•Р»РѕРє",
        "Р•РЅСЃРєРѕРµ",
        "Р•С‚СЂРѕРІСЃРєРёР№",
        "РРЅС†РѕРІРѕ",
        "РРЅС†РѕРІСЃРєРёР№",
        "РСЂРё",
        "РСЃС‚СЂР°",
        "РљР°С€РёСЂР°",
        "РљР»РёРЅ",
        "РљСѓР±РёРЅРєР°",
        "Р›РµРЅРёРЅСЃРєРёР№",
        "Р›РµСЃРµРЅСЃРєРѕРµ",
        "Р›РѕР±Р°Р»",
        "РњР°РЅСѓС€РєРёРЅРѕ",
        "РњРѕР¶Р°Р№СЃРєРёР№",
        "РњРѕСЃРєРІР°",
        "РќР°СЂРѕ-Р¤РѕРјРёРЅСЃРє",
        "РќР°СЂРѕ-Р¤РѕРјРёРЅСЃРєРёР№",
        "РќРµСЃС‚РµСЂРѕРІРѕ",
        "РћР±РЅРёРЅСЃРє",
        "РћРІРѕ-РџСЂРѕРјС‹С€Р»РµРЅРЅРѕРіРѕ",
        "РћРґРёРЅС†РѕРІРѕ",
        "РћРґРёРЅС†РѕРІСЃРєРёР№",
        "РћР»РѕРІРЅРѕР№",
        "РћРјРѕРІРёРє",
        "РћСЂРѕРґ",
        "РћСЂСЃРє",
        "РћСЂСЃРєРёР№",
        "РџРѕРґРѕР»СЊСЃРє",
        "Р РµР»РµРІРєР°",
        "Р РѕСЃСЃ",
        "РЎРµР»СЏС‚РёРЅРѕ",
        "РЎРµСЂРїСѓС…РѕРІ",
        "РЎРѕР»РЅРµС‡РЅРѕРіРѕСЂСЃРє",
        "РўРµС‚РµСЂРёРЅРѕ",
        "РўСѓР»Р°",
        "РҐРёРјРєРё",
        "Р§РµС…РѕРІ",
        "РЁР°С…РѕРІСЃРєР°СЏ",
        "Р©РµСЂР±РёРЅРєР°"
    ]
},
    lastUpdate: new Date().toISOString()
};

// ============================================================================
// РћРЎРќРћР’РќР«Р• Р¤РЈРќРљР¦РР Р¤РР›Р¬РўР РђР¦РР
// ============================================================================

/**
 * РРЅРёС†РёР°Р»РёР·РёСЂСѓРµС‚ СЃРёСЃС‚РµРјСѓ С„РёР»СЊС‚СЂРѕРІ
 */
function initFiltersSystem() {
    console.log('рџ”§ РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ СЃРёСЃС‚РµРјС‹ С„РёР»СЊС‚СЂРѕРІ CRM...');
    
    // Р–РґРµРј Р·Р°РіСЂСѓР·РєРё РґР°РЅРЅС‹С… РєР»РёРµРЅС‚РѕРІ
    waitForClientsData().then(() => {
        createFilterControls();
        setupSearchIntegration();
        applyInitialFilters();
        console.log('вњ… РЎРёСЃС‚РµРјР° С„РёР»СЊС‚СЂРѕРІ РіРѕС‚РѕРІР°');
    }).catch(error => {
        console.error('вќЊ РћС€РёР±РєР° РёРЅРёС†РёР°Р»РёР·Р°С†РёРё С„РёР»СЊС‚СЂРѕРІ:', error);
        showFilterError('РќРµ СѓРґР°Р»РѕСЃСЊ Р·Р°РіСЂСѓР·РёС‚СЊ РґР°РЅРЅС‹Рµ РґР»СЏ С„РёР»СЊС‚СЂР°С†РёРё');
    });
}

/**
 * РћР¶РёРґР°РµС‚ Р·Р°РіСЂСѓР·РєРё РґР°РЅРЅС‹С… РєР»РёРµРЅС‚РѕРІ
 */
function waitForClientsData() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        const checkInterval = setInterval(() => {
            attempts++;
            
            // РџСЂРѕРІРµСЂСЏРµРј РЅР°Р»РёС‡РёРµ РґР°РЅРЅС‹С…
            if (window.allClientsData && Array.isArray(window.allClientsData) && window.allClientsData.length > 0) {
                clearInterval(checkInterval);
                console.log(`рџ“Љ Р”Р°РЅРЅС‹Рµ РєР»РёРµРЅС‚РѕРІ Р·Р°РіСЂСѓР¶РµРЅС‹: ${window.allClientsData.length} Р·Р°РїРёСЃРµР№`);
                resolve(window.allClientsData);
            } 
            // РџСЂРѕРІРµСЂСЏРµРј РЅР°Р»РёС‡РёРµ РґР°РЅРЅС‹С… РёР· Excel
            else if (window.excelRealData && window.excelRealData['Р›РёСЃС‚1']) {
                clearInterval(checkInterval);
                const excelData = window.excelRealData['Р›РёСЃС‚1'];
                console.log(`рџ“Љ Excel РґР°РЅРЅС‹Рµ Р·Р°РіСЂСѓР¶РµРЅС‹: ${excelData.length} Р·Р°РїРёСЃРµР№`);
                window.allClientsData = excelData;
                resolve(excelData);
            }
            else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                reject(new Error('Р”Р°РЅРЅС‹Рµ РєР»РёРµРЅС‚РѕРІ РЅРµ Р·Р°РіСЂСѓР·РёР»РёСЃСЊ'));
            }
        }, 100);
    });
}

/**
 * РЎРѕР·РґР°РµС‚ СЌР»РµРјРµРЅС‚С‹ СѓРїСЂР°РІР»РµРЅРёСЏ С„РёР»СЊС‚СЂР°РјРё
 */
function createFilterControls() {
    const filtersGrid = document.getElementById('filtersGrid');
    if (!filtersGrid) {
        console.warn('Р­Р»РµРјРµРЅС‚ filtersGrid РЅРµ РЅР°Р№РґРµРЅ');
        return;
    }
    
    filtersGrid.innerHTML = '';
    
    // РћРїСЂРµРґРµР»СЏРµРј РґРѕСЃС‚СѓРїРЅС‹Рµ С„РёР»СЊС‚СЂС‹ РЅР° РѕСЃРЅРѕРІРµ РґР°РЅРЅС‹С…
    const availableFilters = getAvailableFilters();
    
    // РЎРѕР·РґР°РµРј С„РёР»СЊС‚СЂС‹ РїРѕ РїРѕСЂСЏРґРєСѓ
    const filterOrder = [
        { id: 'code', label: 'РљРѕРґ', key: 'РљРѕРґ' },
        { id: 'name', label: 'РќР°РёРјРµРЅРѕРІР°РЅРёРµ', key: 'РќР°РёРјРµРЅРѕРІР°РЅРёРµ' },
        { id: 'segment', label: 'РЎРµРіРјРµРЅС‚Р°С†РёСЏ РљР‘', key: 'РЎРµРіРјРµРЅС‚Р°С†РёСЏ РљР‘' },
        { id: 'region', label: 'Р‘РёР·РЅРµСЃ-СЂРµРіРёРѕРЅ', key: 'Р‘РёР·РЅРµСЃ-СЂРµРіРёРѕРЅ' },
        { id: 'business', label: 'Р’РёРґ Р±РёР·РЅРµСЃР°', key: 'Р’РёРґ Р±РёР·РЅРµСЃР°' },
        { id: 'product', label: 'РўРѕРІР°СЂРЅР°СЏ РіСЂСѓРїРїР°', key: 'РўРѕРІР°СЂРЅР°СЏ РіСЂСѓРїРїР°' },
        { id: 'zone', label: 'Р—РѕРЅР° РґРѕСЃС‚Р°РІРєРё', key: 'Р—РѕРЅР°' },
        { id: 'direction', label: 'РќР°РїСЂР°РІР»РµРЅРёРµ', key: 'РќР°РїСЂР°РІР»РµРЅРёРµ' },
        { id: 'address', label: 'РђРґСЂРµСЃ', key: 'РђРґСЂРµСЃ' }
    ];
    
    filterOrder.forEach((filterConfig, index) => {
        const filterKey = filterConfig.key;
        const filterValues = CRM_FILTERS.filters[filterKey];
        
        // РџСЂРѕРїСѓСЃРєР°РµРј С„РёР»СЊС‚СЂ, РµСЃР»Рё РЅРµС‚ РґР°РЅРЅС‹С…
        if (!filterValues || !Array.isArray(filterValues) || filterValues.length === 0) {
            return;
        }
        
        // РЎРѕР·РґР°РµРј РєРѕРЅС‚РµР№РЅРµСЂ С„РёР»СЊС‚СЂР°
        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter-item';
        filterDiv.dataset.filterId = filterConfig.id;
        
        // РЎРѕР·РґР°РµРј label
        const label = document.createElement('label');
        label.textContent = filterConfig.label;
        label.title = `Р¤РёР»СЊС‚СЂ РїРѕ ${filterConfig.label.toLowerCase()}`;
        
        // РЎРѕР·РґР°РµРј select
        const select = document.createElement('select');
        select.className = 'filter-select';
        select.id = `filter_${filterConfig.id}`;
        select.dataset.filterKey = filterKey;
        
        // РћРїС†РёСЏ "Р’СЃРµ"
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = `-- Р’СЃРµ ${filterConfig.label} --`;
        select.appendChild(allOption);
        
        // Р”РѕР±Р°РІР»СЏРµРј Р·РЅР°С‡РµРЅРёСЏ
        filterValues.forEach(value => {
            if (value && value.toString().trim()) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value.length > 35 ? value.substring(0, 35) + '...' : value;
                option.title = value; // РџРѕР»РЅС‹Р№ С‚РµРєСЃС‚ РїСЂРё РЅР°РІРµРґРµРЅРёРё
                select.appendChild(option);
            }
        });
        
        // Р”РѕР±Р°РІР»СЏРµРј СЃС‡РµС‚С‡РёРє
        const counterSpan = document.createElement('span');
        counterSpan.className = 'filter-counter';
        counterSpan.textContent = `(${filterValues.length})`;
        counterSpan.style.cssText = 'margin-left: 5px; font-size: 11px; color: #667eea;';
        
        label.appendChild(counterSpan);
        
        // РћР±СЂР°Р±РѕС‚С‡РёРє РёР·РјРµРЅРµРЅРёСЏ
        select.addEventListener('change', function() {
            onFilterChange();
            highlightActiveFilter(this);
        });
        
        // Р”РѕР±Р°РІР»СЏРµРј СЌР»РµРјРµРЅС‚С‹ РІ DOM
        filterDiv.appendChild(label);
        filterDiv.appendChild(select);
        filtersGrid.appendChild(filterDiv);
    });
    
    // Р”РѕР±Р°РІР»СЏРµРј РєРЅРѕРїРєРё СѓРїСЂР°РІР»РµРЅРёСЏ С„РёР»СЊС‚СЂР°РјРё
    addFilterControls();
}

/**
 * РћРїСЂРµРґРµР»СЏРµС‚ РґРѕСЃС‚СѓРїРЅС‹Рµ С„РёР»СЊС‚СЂС‹ РЅР° РѕСЃРЅРѕРІРµ РґР°РЅРЅС‹С…
 */
function getAvailableFilters() {
    if (!window.allClientsData || window.allClientsData.length === 0) {
        return [];
    }
    
    const firstItem = window.allClientsData[0];
    const availableKeys = Object.keys(firstItem);
    
    // Р’РѕР·РІСЂР°С‰Р°РµРј С‚РѕР»СЊРєРѕ С‚Рµ С„РёР»СЊС‚СЂС‹, РґР»СЏ РєРѕС‚РѕСЂС‹С… РµСЃС‚СЊ РґР°РЅРЅС‹Рµ
    return Object.keys(CRM_FILTERS.filters).filter(key => {
        const values = CRM_FILTERS.filters[key];
        return values && Array.isArray(values) && values.length > 0;
    });
}

/**
 * Р”РѕР±Р°РІР»СЏРµС‚ РєРЅРѕРїРєРё СѓРїСЂР°РІР»РµРЅРёСЏ С„РёР»СЊС‚СЂР°РјРё
 */
function addFilterControls() {
    const filtersGrid = document.getElementById('filtersGrid');
    if (!filtersGrid) return;
    
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'filter-controls';
    controlsDiv.style.cssText = `
        grid-column: 1 / -1;
        display: flex;
        gap: 10px;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid #e9ecef;
    `;
    
    // РљРЅРѕРїРєР° СЃР±СЂРѕСЃР° С„РёР»СЊС‚СЂРѕРІ
    const resetBtn = document.createElement('button');
    resetBtn.textContent = 'вќЊ РЎР±СЂРѕСЃРёС‚СЊ РІСЃРµ С„РёР»СЊС‚СЂС‹';
    resetBtn.className = 'filter-control-btn';
    resetBtn.style.cssText = `
        padding: 8px 15px;
        background: #f8f9fa;
        border: 2px solid #dc3545;
        border-radius: 8px;
        color: #dc3545;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    `;
    resetBtn.onmouseover = () => {
        resetBtn.style.background = '#dc3545';
        resetBtn.style.color = 'white';
    };
    resetBtn.onmouseout = () => {
        resetBtn.style.background = '#f8f9fa';
        resetBtn.style.color = '#dc3545';
    };
    resetBtn.onclick = resetAllFilters;
    
    // РљРЅРѕРїРєР° РїСЂРёРјРµРЅРµРЅРёСЏ
    const applyBtn = document.createElement('button');
    applyBtn.textContent = 'вњ… РџСЂРёРјРµРЅРёС‚СЊ С„РёР»СЊС‚СЂС‹';
    applyBtn.className = 'filter-control-btn';
    applyBtn.style.cssText = `
        padding: 8px 15px;
        background: #4CAF50;
        border: 2px solid #4CAF50;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    `;
    applyBtn.onclick = applyAllFilters;
    
    controlsDiv.appendChild(resetBtn);
    controlsDiv.appendChild(applyBtn);
    filtersGrid.appendChild(controlsDiv);
}

/**
 * РџРѕРґСЃРІРµС‡РёРІР°РµС‚ Р°РєС‚РёРІРЅС‹Р№ С„РёР»СЊС‚СЂ
 */
function highlightActiveFilter(selectElement) {
    // РЎРЅРёРјР°РµРј РїРѕРґСЃРІРµС‚РєСѓ СЃРѕ РІСЃРµС…
    document.querySelectorAll('.filter-select').forEach(select => {
        select.parentElement.style.background = 'transparent';
    });
    
    // РџРѕРґСЃРІРµС‡РёРІР°РµРј Р°РєС‚РёРІРЅС‹Р№
    if (selectElement.value) {
        selectElement.parentElement.style.background = '#e8f5e9';
        selectElement.parentElement.style.borderRadius = '8px';
        selectElement.parentElement.style.padding = '5px';
    }
}

/**
 * РћР±СЂР°Р±РѕС‚С‡РёРє РёР·РјРµРЅРµРЅРёСЏ С„РёР»СЊС‚СЂР°
 */
function onFilterChange() {
    // РџРѕРєР°Р·С‹РІР°РµРј РёРЅРґРёРєР°С‚РѕСЂ Р·Р°РіСЂСѓР·РєРё
    showFilterLoading(true);
    
    // РќРµР±РѕР»СЊС€Р°СЏ Р·Р°РґРµСЂР¶РєР° РґР»СЏ РіСЂСѓРїРїРёСЂРѕРІРєРё Р±С‹СЃС‚СЂС‹С… РёР·РјРµРЅРµРЅРёР№
    clearTimeout(window.filterTimeout);
    window.filterTimeout = setTimeout(() => {
        applyAllFilters();
        showFilterLoading(false);
    }, 300);
}

/**
 * РџСЂРёРјРµРЅСЏРµС‚ РІСЃРµ Р°РєС‚РёРІРЅС‹Рµ С„РёР»СЊС‚СЂС‹
 */
function applyAllFilters() {
    if (!window.allClientsData) {
        console.warn('РќРµС‚ РґР°РЅРЅС‹С… РґР»СЏ С„РёР»СЊС‚СЂР°С†РёРё');
        return;
    }
    
    let filteredData = [...window.allClientsData];
    const activeFilters = [];
    
    // РЎРѕР±РёСЂР°РµРј Р°РєС‚РёРІРЅС‹Рµ С„РёР»СЊС‚СЂС‹
    document.querySelectorAll('.filter-select').forEach(select => {
        if (select.value && select.value.trim() !== '') {
            const filterKey = select.dataset.filterKey;
            const filterValue = select.value;
            
            if (filterKey && filterValue) {
                activeFilters.push({
                    key: filterKey,
                    value: filterValue,
                    label: select.parentElement.querySelector('label').textContent
                });
                
                // РџСЂРёРјРµРЅСЏРµРј С„РёР»СЊС‚СЂ
                filteredData = filteredData.filter(item => {
                    const itemValue = item[filterKey];
                    if (!itemValue) return false;
                    
                    const strValue = String(itemValue).toLowerCase();
                    const filterStr = filterValue.toLowerCase();
                    
                    return strValue.includes(filterStr);
                });
            }
        }
    });
    
    // РћР±РЅРѕРІР»СЏРµРј РіР»РѕР±Р°Р»СЊРЅСѓСЋ РїРµСЂРµРјРµРЅРЅСѓСЋ
    window.filteredClientsData = filteredData;
    
    // РћР±РЅРѕРІР»СЏРµРј РёРЅС‚РµСЂС„РµР№СЃ
    updateFilterResults(filteredData, activeFilters);
    
    // РЎРѕС…СЂР°РЅСЏРµРј СЃРѕСЃС‚РѕСЏРЅРёРµ С„РёР»СЊС‚СЂРѕРІ
    saveFilterState();
}

/**
 * РћР±РЅРѕРІР»СЏРµС‚ СЂРµР·СѓР»СЊС‚Р°С‚С‹ С„РёР»СЊС‚СЂР°С†РёРё
 */
function updateFilterResults(filteredData, activeFilters = []) {
    // РћР±РЅРѕРІР»СЏРµРј СЃС‡РµС‚С‡РёРє
    const counterElement = document.getElementById('filteredCount');
    if (counterElement) {
        if (activeFilters.length > 0) {
            const filterText = activeFilters.map(f => `${f.label}: ${f.value}`).join(', ');
            counterElement.innerHTML = `
                <span style="color: #4CAF50;">вњ“</span>
                РќР°Р№РґРµРЅРѕ: <strong>${filteredData.length}</strong> РєР»РёРµРЅС‚РѕРІ
                <span style="font-size: 12px; color: #666; margin-left: 10px;">
                    (Р¤РёР»СЊС‚СЂС‹: ${filterText})
                </span>
            `;
        } else {
            counterElement.innerHTML = `
                Р’СЃРµРіРѕ: <strong>${filteredData.length}</strong> РєР»РёРµРЅС‚РѕРІ
                <span style="font-size: 12px; color: #666; margin-left: 10px;">
                    (Р¤РёР»СЊС‚СЂС‹ РЅРµ РїСЂРёРјРµРЅРµРЅС‹)
                </span>
            `;
        }
    }
    
    // РћР±РЅРѕРІР»СЏРµРј С‚Р°Р±Р»РёС†Сѓ РµСЃР»Рё С„СѓРЅРєС†РёСЏ СЃСѓС‰РµСЃС‚РІСѓРµС‚
    if (typeof window.loadClientsTable === 'function') {
        window.currentPage = 1; // РЎР±СЂР°СЃС‹РІР°РµРј РЅР° РїРµСЂРІСѓСЋ СЃС‚СЂР°РЅРёС†Сѓ
        window.loadClientsTable();
    }
    
    // РџРѕРєР°Р·С‹РІР°РµРј СѓРІРµРґРѕРјР»РµРЅРёРµ
    if (activeFilters.length > 0) {
        showFilterNotification(`РџСЂРёРјРµРЅРµРЅРѕ ${activeFilters.length} С„РёР»СЊС‚СЂРѕРІ. РќР°Р№РґРµРЅРѕ: ${filteredData.length} Р·Р°РїРёСЃРµР№`);
    }
}

/**
 * РЎР±СЂР°СЃС‹РІР°РµС‚ РІСЃРµ С„РёР»СЊС‚СЂС‹
 */
function resetAllFilters() {
    document.querySelectorAll('.filter-select').forEach(select => {
        select.value = '';
        select.parentElement.style.background = 'transparent';
    });
    
    applyAllFilters();
    showFilterNotification('Р’СЃРµ С„РёР»СЊС‚СЂС‹ СЃР±СЂРѕС€РµРЅС‹');
}

/**
 * РџСЂРёРјРµРЅСЏРµС‚ РЅР°С‡Р°Р»СЊРЅС‹Рµ С„РёР»СЊС‚СЂС‹
 */
function applyInitialFilters() {
    // РџСЂРѕРІРµСЂСЏРµРј СЃРѕС…СЂР°РЅРµРЅРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ
    const savedState = loadFilterState();
    if (savedState) {
        // Р’РѕСЃСЃС‚Р°РЅР°РІР»РёРІР°РµРј Р·РЅР°С‡РµРЅРёСЏ С„РёР»СЊС‚СЂРѕРІ
        Object.entries(savedState).forEach(([filterId, value]) => {
            const select = document.getElementById(`filter_${filterId}`);
            if (select && value) {
                select.value = value;
            }
        });
    }
    
    applyAllFilters();
}

/**
 * РЎРѕС…СЂР°РЅСЏРµС‚ СЃРѕСЃС‚РѕСЏРЅРёРµ С„РёР»СЊС‚СЂРѕРІ
 */
function saveFilterState() {
    const state = {};
    
    document.querySelectorAll('.filter-select').forEach(select => {
        if (select.value) {
            const filterId = select.id.replace('filter_', '');
            state[filterId] = select.value;
        }
    });
    
    try {
        localStorage.setItem('crm_filter_state', JSON.stringify(state));
    } catch (e) {
        console.warn('РќРµ СѓРґР°Р»РѕСЃСЊ СЃРѕС…СЂР°РЅРёС‚СЊ СЃРѕСЃС‚РѕСЏРЅРёРµ С„РёР»СЊС‚СЂРѕРІ:', e);
    }
}

/**
 * Р—Р°РіСЂСѓР¶Р°РµС‚ СЃРѕС…СЂР°РЅРµРЅРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ С„РёР»СЊС‚СЂРѕРІ
 */
function loadFilterState() {
    try {
        const saved = localStorage.getItem('crm_filter_state');
        return saved ? JSON.parse(saved) : null;
    } catch (e) {
        console.warn('РќРµ СѓРґР°Р»РѕСЃСЊ Р·Р°РіСЂСѓР·РёС‚СЊ СЃРѕСЃС‚РѕСЏРЅРёРµ С„РёР»СЊС‚СЂРѕРІ:', e);
        return null;
    }
}

/**
 * РРЅС‚РµРіСЂРёСЂСѓРµС‚ С„РёР»СЊС‚СЂС‹ СЃ РїРѕРёСЃРєРѕРј
 */
function setupSearchIntegration() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    // РћР±СЂР°Р±РѕС‚С‡РёРє РїРѕРёСЃРєР°
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm) {
            // Р’СЂРµРјРµРЅРЅРѕ РѕС‚РєР»СЋС‡Р°РµРј С„РёР»СЊС‚СЂС‹ РїСЂРё РїРѕРёСЃРєРµ
            const searchResults = window.allClientsData.filter(item => {
                return Object.values(item).some(value => {
                    return String(value).toLowerCase().includes(searchTerm);
                });
            });
            
            window.filteredClientsData = searchResults;
            updateFilterResults(searchResults, [{label: 'РџРѕРёСЃРє', value: searchTerm}]);
            
            if (typeof window.loadClientsTable === 'function') {
                window.loadClientsTable();
            }
        } else {
            // Р’РѕР·РІСЂР°С‰Р°РµРј С„РёР»СЊС‚СЂС‹ РїСЂРё РѕС‡РёСЃС‚РєРµ РїРѕРёСЃРєР°
            applyAllFilters();
        }
    });
}

/**
 * РџРѕРєР°Р·С‹РІР°РµС‚ РёРЅРґРёРєР°С‚РѕСЂ Р·Р°РіСЂСѓР·РєРё
 */
function showFilterLoading(show) {
    let loader = document.getElementById('filterLoader');
    
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'filterLoader';
            loader.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            `;
            loader.innerHTML = `
                <div class="spinner"></div>
                <div>РџСЂРёРјРµРЅРµРЅРёРµ С„РёР»СЊС‚СЂРѕРІ...</div>
            `;
            document.body.appendChild(loader);
            
            // Р”РѕР±Р°РІР»СЏРµРј СЃС‚РёР»Рё РґР»СЏ СЃРїРёРЅРЅРµСЂР°
            const style = document.createElement('style');
            style.textContent = `
                .spinner {
                    width: 40px;
                    height: 40px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #667eea;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
    } else if (loader) {
        loader.remove();
    }
}

/**
 * РџРѕРєР°Р·С‹РІР°РµС‚ СѓРІРµРґРѕРјР»РµРЅРёРµ Рѕ С„РёР»СЊС‚СЂР°С†РёРё
 */
function showFilterNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'filter-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'info' ? '#667eea' : type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        font-size: 14px;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'info' ? 'info-circle' : type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // РЈРґР°Р»СЏРµРј С‡РµСЂРµР· 3 СЃРµРєСѓРЅРґС‹
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    // Р”РѕР±Р°РІР»СЏРµРј Р°РЅРёРјР°С†РёРё РµСЃР»Рё РёС… РЅРµС‚
    if (!document.querySelector('#filter-animations')) {
        const style = document.createElement('style');
        style.id = 'filter-animations';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}

/**
 * РџРѕРєР°Р·С‹РІР°РµС‚ РѕС€РёР±РєСѓ С„РёР»СЊС‚СЂР°С†РёРё
 */
function showFilterError(message) {
    const filtersGrid = document.getElementById('filtersGrid');
    if (!filtersGrid) return;
    
    filtersGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">рџ”§</div>
            <h3>РЎРёСЃС‚РµРјР° С„РёР»СЊС‚СЂРѕРІ РІСЂРµРјРµРЅРЅРѕ РЅРµРґРѕСЃС‚СѓРїРЅР°</h3>
            <p>${message}</p>
            <button onclick="initFiltersSystem()" 
                    style="margin-top: 20px; padding: 10px 20px; 
                           background: #667eea; color: white; 
                           border: none; border-radius: 8px; 
                           cursor: pointer;">
                РџРѕРїСЂРѕР±РѕРІР°С‚СЊ СЃРЅРѕРІР°
            </button>
        </div>
    `;
}

// ============================================================================
// Р­РљРЎРџРћР Рў Р¤РЈРќРљР¦РР™
// ============================================================================

// Р”РµР»Р°РµРј С„СѓРЅРєС†РёРё РґРѕСЃС‚СѓРїРЅС‹РјРё РіР»РѕР±Р°Р»СЊРЅРѕ
window.CRMFilters = {
    init: initFiltersSystem,
    apply: applyAllFilters,
    reset: resetAllFilters,
    getState: loadFilterState,
    saveState: saveFilterState
};

// РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РёРЅРёС†РёР°Р»РёР·Р°С†РёСЏ РїСЂРё Р·Р°РіСЂСѓР·РєРµ СЃС‚СЂР°РЅРёС†С‹
document.addEventListener('DOMContentLoaded', function() {
    // РќРµР±РѕР»СЊС€Р°СЏ Р·Р°РґРµСЂР¶РєР° РґР»СЏ Р·Р°РіСЂСѓР·РєРё РѕСЃРЅРѕРІРЅС‹С… СЃРєСЂРёРїС‚РѕРІ
    setTimeout(initFiltersSystem, 500);
});

console.log('рџљЂ РЎРёСЃС‚РµРјР° РґРёРЅР°РјРёС‡РµСЃРєРёС… С„РёР»СЊС‚СЂРѕРІ CRM Р·Р°РіСЂСѓР¶РµРЅР° Рё РіРѕС‚РѕРІР° Рє СЂР°Р±РѕС‚Рµ!');
