<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВЕРТУМ CRM - Торговая система</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
    /* ОСНОВНЫЕ СТИЛИ */
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #4CAF50;
        --warning-color: #FF9800;
        --danger-color: #f44336;
        --info-color: #2196F3;
        --light-bg: #f8f9fa;
        --dark-text: #2d3748;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--dark-text);
        line-height: 1.6;
    }
    
    /* ШАПКА */
    .crm-header {
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 12px 0;
    }
    
    .header-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: bold;
        color: var(--secondary-color);
    }
    
    .logo i {
        font-size: 24px;
        color: var(--primary-color);
    }
    
    /* МЕНЕДЖЕР */
    .manager-selector {
        position: relative;
        min-width: 300px;
    }
    
    .current-manager {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%);
        padding: 10px 16px;
        border-radius: var(--border-radius);
        border: 2px solid var(--primary-color);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .current-manager:hover {
        border-color: var(--secondary-color);
        transform: translateY(-1px);
        box-shadow: var(--box-shadow);
    }
    
    .manager-info {
        flex-grow: 1;
    }
    
    .manager-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--dark-text);
        margin-bottom: 3px;
    }
    
    .manager-contacts {
        font-size: 12px;
        color: #666;
    }
    
    .manager-arrow {
        color: var(--primary-color);
        margin-left: 10px;
        transition: var(--transition);
    }
    
    .current-manager.active .manager-arrow {
        transform: rotate(180deg);
    }
    
    .managers-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--primary-color);
        border-radius: var(--border-radius);
        margin-top: 8px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        z-index: 1001;
        overflow: hidden;
        display: none;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .manager-option {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .manager-option:hover {
        background: var(--light-bg);
    }
    
    .manager-option.active {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-left: 4px solid var(--success-color);
    }
    
    .manager-option i {
        color: var(--primary-color);
        margin-right: 12px;
        font-size: 16px;
    }
    
    /* КНОПКИ В ШАПКЕ */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .header-btn {
        background: linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%);
        border: 2px solid var(--primary-color);
        padding: 8px 16px;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--dark-text);
        transition: var(--transition);
    }
    
    .header-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-color: transparent;
    }
    
    .btn-visit-header {
        background: linear-gradient(135deg, var(--warning-color) 0%, #F57C00 100%);
        color: white !important;
        border: none;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: var(--transition);
        min-width: 160px;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(255, 152, 0, 0.3);
    }
    
    .btn-visit-header:hover {
        background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(245, 124, 0, 0.4);
    }
    
    /* ГЛАВНОЕ МЕНЮ */
    .crm-main {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
        min-height: calc(100vh - 200px);
    }
    
    .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 25px 0;
    }
    
    .menu-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        cursor: pointer;
        border: 2px solid var(--primary-color);
        transition: var(--transition);
        box-shadow: var(--box-shadow);
        position: relative;
        overflow: hidden;
    }
    
    .menu-card:hover {
        transform: translateY(-5px);
        border-color: var(--secondary-color);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .menu-card.active {
        background: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        border-color: var(--success-color);
    }
    
    .menu-icon {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    
    .menu-icon i {
        font-size: 32px;
        color: var(--primary-color);
    }
    
    .menu-badge {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
    }
    
    .menu-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--dark-text);
        margin-bottom: 8px;
    }
    
    .menu-subtitle {
        font-size: 13px;
        color: #666;
        margin-bottom: 20px;
        line-height: 1.4;
    }
    
    .menu-action {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }
    
    .menu-action::after {
        content: "→";
        font-size: 16px;
    }
    
    /* СТАТИСТИКА */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 30px 0;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: var(--box-shadow);
        border: 2px solid var(--primary-color);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        border-color: var(--secondary-color);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    }
    
    .stat-card i {
        font-size: 28px;
        color: var(--primary-color);
        margin-bottom: 15px;
        display: block;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--dark-text);
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* РАЗДЕЛ КЛИЕНТОВ */
    .section-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        box-shadow: var(--box-shadow);
        border: 2px solid var(--primary-color);
        display: none;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary-color);
    }
    
    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--dark-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: var(--primary-color);
        font-size: 24px;
    }
    
    .manager-badge {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
    }
    
    .section-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .counter-badge {
        background: var(--light-bg);
        padding: 7px 14px;
        border-radius: 20px;
        font-size: 12px;
        color: var(--dark-text);
        border: 1px solid var(--primary-color);
    }
    
    .action-btn {
        padding: 9px 18px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        transition: var(--transition);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
        color: white;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--info-color) 0%, #0D47A1 100%);
        color: white;
    }
    
    .btn-info {
        background: linear-gradient(135deg, var(--info-color) 0%, #0D47A1 100%);
        color: white;
    }
    
    .btn-green {
        background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, var(--warning-color) 0%, #F57C00 100%);
        color: white;
    }
    
    /* ПОИСК И ФИЛЬТРЫ */
    .search-box {
        margin: 20px 0;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 13px 15px 13px 45px;
        border: 2px solid var(--primary-color);
        border-radius: var(--border-radius);
        font-size: 14px;
        background: white;
        color: var(--dark-text);
        box-shadow: 0 1px 3px rgba(102, 126, 234, 0.1);
        transition: var(--transition);
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 3px 10px rgba(118, 75, 162, 0.2);
    }
    
    .search-box::before {
        content: '🔍';
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        color: var(--primary-color);
    }
    
    .filters-grid {  
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 25px 0;
        padding: 20px;
        background: linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%);
        border-radius: var(--border-radius);
        border: 2px solid var(--primary-color);
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
    }
    
    .filter-item label {
        font-size: 12px;
        color: var(--primary-color);
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-select {
        padding: 11px 13px;
        border: 2px solid var(--primary-color);
        border-radius: var(--border-radius);
        background: white;
        font-size: 13px;
        cursor: pointer;
        color: var(--dark-text);
        font-weight: 500;
        transition: var(--transition);
    }
    
    .filter-select:hover {
        border-color: var(--secondary-color);
    }
    
    .filter-select:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 2px 5px rgba(118, 75, 162, 0.2);
    }
    
    /* ТАБЛИЦЫ */
    .table-container {
        overflow-x: auto;
        margin: 25px 0;
        border: 2px solid var(--primary-color);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        max-height: 500px;
        position: relative;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px;
    }
    
    .data-table th {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 14px 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .data-table td {
        padding: 12px 12px;
        border-bottom: 1px solid #f1f3f4;
        font-size: 13px;
        color: var(--dark-text);
        vertical-align: middle;
    }
    
    .data-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .data-table tr:hover {
        background: linear-gradient(135deg, #f3f0ff 0%, #e9ecef 100%);
        box-shadow: 0 1px 3px rgba(102, 126, 234, 0.1);
    }
    
    .checkbox-cell {
        text-align: center;
        width: 30px;
    }
    
    .action-cell {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .btn-small {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .btn-small:hover {
        transform: translateY(-1px);
    }
    
    /* ПАГИНАЦИЯ */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 25px 0;
        padding: 20px;
        background: var(--light-bg);
        border-radius: var(--border-radius);
        border: 2px solid var(--primary-color);
        flex-wrap: wrap;
    }
    
    .page-btn {
        padding: 7px 14px;
        border: 1px solid var(--primary-color);
        background: white;
        border-radius: var(--border-radius);
        cursor: pointer;
        color: var(--primary-color);
        font-weight: 600;
        transition: var(--transition);
        font-size: 13px;
        min-width: 40px;
        text-align: center;
    }
    
    .page-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-color: transparent;
        transform: translateY(-1px);
    }
    
    .page-btn.active {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-color: transparent;
    }
    
    /* КНОПКИ ДЕЙСТВИЙ */
    .action-btns {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 2px solid var(--primary-color);
        flex-wrap: wrap;
    }
    
    /* КАЛЕНДАРЬ */
    .calendar-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        box-shadow: var(--box-shadow);
        border: 2px solid var(--primary-color);
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin: 20px 0;
    }
    
    .calendar-weekday {
        text-align: center;
        padding: 12px 0;
        font-weight: 600;
        color: var(--primary-color);
        background: var(--light-bg);
        border-radius: var(--border-radius);
    }
    
    .calendar-day {
        text-align: center;
        padding: 15px 0;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        background: white;
        border: 1px solid #e9ecef;
    }
    
    .calendar-day:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        transform: scale(1.05);
        border-color: transparent;
    }
    
    .calendar-day.today {
        background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
    }
    
    .calendar-day.event {
        background: linear-gradient(135deg, var(--warning-color) 0%, #F57C00 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 2px 5px rgba(255, 152, 0, 0.3);
    }
    
    /* УВЕДОМЛЕНИЯ */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .notification {
        background: white;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        border-left: 5px solid var(--success-color);
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification.error {
        border-left-color: var(--danger-color);
    }
    
    .notification.warning {
        border-left-color: var(--warning-color);
    }
    
    .notification.info {
        border-left-color: var(--info-color);
    }
    
    .notification-icon {
        font-size: 20px;
    }
    
    .notification-content {
        flex-grow: 1;
    }
    
    .notification-title {
        font-weight: 600;
        margin-bottom: 3px;
    }
    
    .notification-message {
        font-size: 13px;
        color: #666;
    }
    
    /* МОДАЛЬНЫЕ ОКНА */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal {
        background: white;
        border-radius: 12px;
        padding: 30px;
        min-width: 500px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        border: 2px solid var(--primary-color);
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary-color);
    }
    
    .modal-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--dark-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        transition: var(--transition);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        background: var(--light-bg);
        color: var(--primary-color);
    }
    
    /* АКТИВНЫЙ ВИЗИТ */
    .active-visit-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
        color: white;
        padding: 12px 25px;
        display: none;
        z-index: 9998;
        box-shadow: 0 -4px 15px rgba(76, 175, 80, 0.3);
        animation: slideUpBar 0.3s ease;
    }
    
    @keyframes slideUpBar {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    
    .active-visit-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
        font-size: 14px;
    }
    
    .active-visit-info strong {
        margin-right: 8px;
    }
    
    /* ФУТЕР */
    .crm-footer {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        color: white;
        padding: 30px 20px 20px;
        margin-top: 40px;
        border-top: 3px solid var(--primary-color);
    }
    
    .footer-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .footer-column h3 {
        margin-bottom: 18px;
        font-size: 15px;
        color: var(--primary-color);
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .footer-links {
        list-style: none;
        padding: 0;
    }
    
    .footer-links li {
        margin-bottom: 10px;
    }
    
    .footer-links a {
        color: white;
        text-decoration: none;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: var(--transition);
        padding: 5px 0;
    }
    
    .footer-links a:hover {
        color: var(--primary-color);
        transform: translateX(5px);
    }
    
    .footer-btn {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        width: 100%;
        justify-content: center;
        transition: var(--transition);
    }
    
    .footer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
    }
    
    .copyright {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        font-size: 13px;
        color: #aaa;
    }
    
    /* АКТИВНЫЕ ФИЛЬТРЫ */
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .filter-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .filter-reset-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 7px 14px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .filter-reset-btn:hover {
        background: #d32f2f;
        transform: translateY(-1px);
    }
    
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 15px 0;
        padding: 15px;
        background: #f0f7f0;
        border-radius: var(--border-radius);
        border-left: 5px solid var(--success-color);
        min-height: 55px;
        align-items: center;
    }
    
    .filter-tag {
        background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
    }
    
    .filter-tag-remove {
        cursor: pointer;
        font-size: 11px;
        opacity: 0.8;
    }
    
    .filter-tag-remove:hover {
        opacity: 1;
    }
    
    /* РЕГИСТРАЦИОННАЯ ФОРМА */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--dark-text);
        font-size: 13px;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        font-size: 14px;
        transition: var(--transition);
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        font-size: 14px;
        min-height: 120px;
        resize: vertical;
        transition: var(--transition);
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* ОТВЕТСТВЕННЫЙ ДИЗАЙН */
    @media (max-width: 1200px) {
        .header-container {
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .manager-selector {
            min-width: 250px;
        }
    }
    
    @media (max-width: 768px) {
        .crm-main {
            padding: 0 15px;
        }
        
        .menu-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .section-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .action-btns {
            flex-direction: column;
        }
        
        .modal {
            min-width: auto;
            width: 95%;
            padding: 20px;
        }
        
        .footer-container {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .header-actions {
            flex-wrap: wrap;
        }
        
        .btn-visit-header {
            min-width: 140px;
            font-size: 13px;
        }
        
        .menu-card {
            padding: 20px;
        }
    }
    </style>
</head>
<body>
    <!-- ШАПКА -->
    <header class="crm-header">
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>ВЕРТУМ CRM</span>
            </div>

            <div class="manager-selector">
                <div class="current-manager" id="currentManager" onclick="toggleManagerDropdown()">
                    <div class="manager-info">
                        <div class="manager-name" id="currentManagerName">Хисматуллин Рустам Шафкатович</div>
                        <div class="manager-contacts" id="currentManagerContacts">
                            hrs@vertum.su • +7 (985) 710-21-27
                        </div>
                    </div>
                    <i class="fas fa-chevron-down manager-arrow"></i>
                </div>
                
                <div class="managers-dropdown" id="managersDropdown">
                    <div class="manager-option active" onclick="selectManager('Хисматуллин')">
                        <i class="fas fa-user-tie"></i>
                        <div>
                            <div class="manager-name">Хисматуллин Рустам Шафкатович</div>
                            <div class="manager-contacts">hrs@vertum.su • +7 (985) 710-21-27</div>
                        </div>
                    </div>
                    <div class="manager-option" onclick="selectManager('Хитров')">
                        <i class="fas fa-user-tie"></i>
                        <div>
                            <div class="manager-name">Хитров Кирилл Юрьевич</div>
                            <div class="manager-contacts">hky@vertum.su • +7 (909) 624-99-00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="header-actions">
                <button class="header-btn" onclick="syncData()">
                    <i class="fas fa-sync-alt"></i> Синхр.
                </button>
                <button class="header-btn" onclick="sendReport()">
                    <i class="fas fa-paper-plane"></i> Отчет
                </button>
                <button class="btn-visit-header" onclick="startVisit()" id="startVisitBtn">
                    <i class="fas fa-play-circle"></i> НАЧАТЬ ВИЗИТ
                </button>
            </div>
        </div>
    </header>

    <!-- УВЕДОМЛЕНИЯ -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- АКТИВНЫЙ ВИЗИТ -->
    <div class="active-visit-bar" id="activeVisitBar">
        <div class="active-visit-info">
            <div>
                <strong>🚗 АКТИВНЫЙ ВИЗИТ:</strong> 
                <span id="activeVisitClient"></span> • 
                <span id="activeVisitTime"></span>
                <span id="activeVisitDuration" style="margin-left: 15px;"></span>
            </div>
            <button class="btn-visit-header" onclick="openActiveVisit()">
                <i class="fas fa-external-link-alt"></i> Продолжить
            </button>
        </div>
    </div>

    <!-- ОСНОВНОЙ КОНТЕЙНЕР -->
    <main class="crm-main">
        <!-- ГЛАВНОЕ МЕНЮ -->
        <div class="menu-grid" id="mainMenu">
            <div class="menu-card active" onclick="showSection('clients')" data-section="clients">
                <div class="menu-icon">
                    <i class="fas fa-users"></i>
                    <span class="menu-badge" id="clientsCount">0</span>
                </div>
                <div class="menu-title">ВСЕ КЛИЕНТЫ</div>
                <div class="menu-subtitle">Таблица с фильтрами, поиском и экспортом</div>
                <div class="menu-action">Смотреть →</div>
            </div>

            <div class="menu-card" onclick="showSection('excelData')" data-section="excelData">
                <div class="menu-icon">
                    <i class="fas fa-file-excel"></i>
                    <span class="menu-badge" id="excelSheetsCount">4</span>
                </div>
                <div class="menu-title">ДАННЫЕ EXCEL</div>
                <div class="menu-subtitle">Импорт/экспорт данных Excel</div>
                <div class="menu-action">Открыть →</div>
            </div>

            <div class="menu-card" onclick="showCalendar()">
                <div class="menu-icon">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="menu-badge" id="calendarEvents">3</span>
                </div>
                <div class="menu-title">КАЛЕНДАРЬ</div>
                <div class="menu-subtitle">Встречи, визиты, дни рождения</div>
                <div class="menu-action">Просмотреть →</div>
            </div>

            <div class="menu-card" onclick="showVisitsHistory()">
                <div class="menu-icon">
                    <i class="fas fa-history"></i>
                    <span class="menu-badge" id="visitsHistoryCount">0</span>
                </div>
                <div class="menu-title">ИСТОРИЯ ВИЗИТОВ</div>
                <div class="menu-subtitle">Архив всех встреч и визитов</div>
                <div class="menu-action">Просмотреть →</div>
            </div>

            <div class="menu-card" onclick="showRegistrationForm()">
                <div class="menu-icon">
                    <i class="fas fa-user-plus"></i>
                    <span class="menu-badge">+</span>
                </div>
                <div class="menu-title">РЕГИСТРАЦИЯ</div>
                <div class="menu-subtitle">Новый клиент в системе</div>
                <div class="menu-action">Заполнить →</div>
            </div>

            <div class="menu-card" onclick="startVisit()">
                <div class="menu-icon">
                    <i class="fas fa-play-circle"></i>
                    <span class="menu-badge" id="visitsToday">0</span>
                </div>
                <div class="menu-title">НАЧАТЬ ВИЗИТ</div>
                <div class="menu-subtitle">Активные посещения клиентов</div>
                <div class="menu-action">СТАРТ →</div>
            </div>
        </div>

        <!-- МИНИ-КАЛЕНДАРЬ -->
        <div class="calendar-section" id="miniCalendar">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calendar-day"></i>
                    БЛИЖАЙШИЕ ВСТРЕЧИ
                </div>
                <button class="action-btn btn-info" onclick="showCalendar()">
                    <i class="fas fa-expand"></i> Весь календарь
                </button>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-weekday">Пн</div>
                <div class="calendar-weekday">Вт</div>
                <div class="calendar-weekday">Ср</div>
                <div class="calendar-weekday">Чт</div>
                <div class="calendar-weekday">Пт</div>
                <div class="calendar-weekday">Сб</div>
                <div class="calendar-weekday">Вс</div>
                
                <!-- Заполняется динамически -->
            </div>
            
            <div style="margin-top: 20px;" id="calendarEventsList">
                <div style="padding: 12px; background: #f8f9fa; border-radius: var(--border-radius); margin-bottom: 8px;">
                    <div style="font-weight: 600; color: var(--dark-text);">Завтра, 10:00</div>
                    <div style="font-size: 13px; color: #666;">Встреча с Звонаревым В.А.</div>
                    <div style="font-size: 12px; color: #888;">Серпухов, Калиновский рынок</div>
                </div>
            </div>
        </div>

        <!-- СТАТИСТИКА -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <div class="stat-value" id="statTotalClients">0</div>
                <div class="stat-label">Всего клиентов</div>
            </div>

            <div class="stat-card">
                <i class="fas fa-ruble-sign"></i>
                <div class="stat-value">158.4M ₽</div>
                <div class="stat-label">Продажи 2025</div>
            </div>

            <div class="stat-card">
                <i class="fas fa-bullseye"></i>
                <div class="stat-value">210M ₽</div>
                <div class="stat-label">План 2026</div>
            </div>

            <div class="stat-card">
                <i class="fas fa-calendar-check"></i>
                <div class="stat-value" id="statVisitsCount">0</div>
                <div class="stat-label">Визитов в 2026</div>
            </div>

            <div class="stat-card">
                <i class="fas fa-percentage"></i>
                <div class="stat-value">24%</div>
                <div class="stat-label">Выполнение плана</div>
            </div>

            <div class="stat-card">
                <i class="fas fa-boxes"></i>
                <div class="stat-value">7</div>
                <div class="stat-label">Товарных групп</div>
            </div>
        </div>

        <!-- РАЗДЕЛ "ВСЕ КЛИЕНТЫ" -->
        <div id="clientsSection" class="section-container">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-users"></i>
                    ВСЕ КЛИЕНТЫ
                    <span class="manager-badge" id="currentManagerBadge">Хисматуллин Р.Ш.</span>
                </div>
                <div class="section-actions">
                    <span class="counter-badge" id="filteredCount">
                        Показано: <strong>0</strong> из <strong>0</strong>
                    </span>
                    <button class="action-btn btn-success" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="action-btn btn-primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="action-btn btn-info" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i> Отчет
                    </button>
                    <button class="action-btn btn-green" onclick="showRegistrationForm()">
                        <i class="fas fa-plus"></i> Новый клиент
                    </button>
                    <button class="btn-visit-header" style="padding: 8px 15px; font-size: 13px;" onclick="startVisitFromTable()">
                        <i class="fas fa-play-circle"></i> Начать визит
                    </button>
                </div>
            </div>

            <!-- ПАНЕЛЬ УПРАВЛЕНИЯ ФИЛЬТРАМИ -->
            <div class="filters-header">
                <h4><i class="fas fa-filter"></i> ФИЛЬТРЫ КЛИЕНТОВ</h4>
                <div class="filter-controls">
                    <button class="filter-reset-btn" onclick="resetAllFilters()">
                        <i class="fas fa-times"></i> Сбросить все
                    </button>
                    <span class="counter-badge" id="activeFiltersCount">Активных фильтров: 0</span>
                </div>
            </div>

            <!-- АКТИВНЫЕ ФИЛЬТРЫ -->
            <div class="active-filters" id="activeFiltersContainer" style="display: none;">
                <!-- Активные фильтры отображаются здесь -->
            </div>

            <!-- ПОИСК -->
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="🔍 Поиск по коду, названию, адресу, телефону..." 
                       oninput="filterTable()">
            </div>

            <!-- ФИЛЬТРЫ (9 штук) -->
            <div class="filters-grid" id="filtersGrid">
                <!-- Фильтры загружаются динамически -->
            </div>

            <!-- ТАБЛИЦА КЛИЕНТОВ -->
            <div class="table-container">
                <table class="data-table" id="clientsTable">
                    <thead id="clientsTableHead">
                        <!-- Заголовки загружаются динамически -->
                    </thead>
                    <tbody id="clientsTableBody">
                        <!-- Данные загружаются динамически -->
                    </tbody>
                </table>
            </div>

            <!-- ПАГИНАЦИЯ -->
            <div class="pagination" id="pagination">
                <!-- Страницы загружаются динамически -->
            </div>

            <!-- ДЕЙСТВИЯ -->
            <div class="action-btns">
                <button class="action-btn" style="background: #666; color: white;" onclick="showSection('main')">
                    <i class="fas fa-arrow-left"></i> Назад в меню
                </button>
                <button class="action-btn btn-primary" onclick="showRegistrationForm()">
                    <i class="fas fa-user-plus"></i> Новый клиент
                </button>
                <button class="action-btn btn-info" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i> Создать отчет
                </button>
                <button class="btn-visit-header" style="padding: 8px 15px; font-size: 13px;" onclick="startVisitFromTable()">
                    <i class="fas fa-play-circle"></i> Начать визит
                </button>
            </div>
        </div>

        <!-- РАЗДЕЛ "ДАННЫЕ EXCEL" -->
        <div id="excelDataSection" class="section-container">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-file-excel"></i>
                    ДАННЫЕ ИЗ EXCEL ФАЙЛА
                    <span class="manager-badge">Хисматуллин КБ срм.xlsx</span>
                </div>
                <div class="section-actions">
                    <span class="counter-badge" id="excelCount">
                        Загружено: <strong>0</strong> записей
                    </span>
                    <button class="action-btn btn-success" onclick="exportExcelToCSV()">
                        <i class="fas fa-download"></i> Экспорт CSV
                    </button>
                    <button class="action-btn" style="background: #666; color: white;" onclick="refreshExcelData()">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                    <button class="action-btn btn-info" onclick="generateExcelReport()">
                        <i class="fas fa-chart-bar"></i> Отчет по Excel
                    </button>
                </div>
            </div>

            <div class="excel-controls" style="margin: 20px 0;">
                <select id="excelSheetSelect" class="filter-select" onchange="loadExcelSheet()" style="margin-right: 10px;">
                    <option value="">Выберите лист Excel...</option>
                </select>
                
                <input type="text" class="search-input" id="excelSearchInput" 
                       placeholder="🔍 Поиск по всем листам..." 
                       style="flex-grow: 1;"
                       oninput="searchExcelData()">
                
                <button class="action-btn btn-warning" onclick="importExcelFile()" style="margin-left: 10px;">
                    <i class="fas fa-upload"></i> Импорт Excel
                </button>
            </div>

            <div class="table-container">
                <table class="data-table" id="excelDataTable">
                    <thead id="excelTableHead">
                        <!-- Заголовки загружаются динамически -->
                    </thead>
                    <tbody id="excelTableBody">
                        <!-- Данные загружаются динамически -->
                    </tbody>
                </table>
            </div>

            <div class="excel-stats" id="excelStats" style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color); min-width: 150px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">Текущий лист</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--dark-text);" id="currentSheetName">—</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid var(--success-color); min-width: 150px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">Записей</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--dark-text);" id="excelRowCount">0</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid var(--info-color); min-width: 150px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">Столбцов</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--dark-text);" id="excelColCount">0</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid var(--warning-color); min-width: 150px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">Обновлено</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--dark-text);" id="excelUpdateTime">—</div>
                </div>
            </div>

            <div class="action-btns">
                <button class="action-btn" style="background: #666; color: white;" onclick="showSection('main')">
                    <i class="fas fa-arrow-left"></i> Назад в меню
                </button>
                <button class="action-btn btn-success" onclick="exportExcelToCSV()">
                    <i class="fas fa-download"></i> Экспорт CSV
                </button>
                <button class="action-btn btn-primary" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Экспорт Excel
                </button>
            </div>
        </div>
    </main>

    <!-- МОДАЛЬНЫЕ ОКНА -->
    <div class="modal-overlay" id="visitModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">
                    <i class="fas fa-car"></i> НАЧАТЬ ВИЗИТ
                </div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            
            <div id="modalContent">
                <!-- Контент загружается динамически -->
            </div>
        </div>
    </div>

    <!-- ФУТЕР -->
    <footer class="crm-footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>ВЕРТУМ CRM</h3>
                <p style="font-size: 13px; color: #ccc; margin-bottom: 20px; line-height: 1.5;">
                    Торговая система управления клиентами. Полный контроль над визитами, встречами и продажами.
                </p>
                <div class="footer-contacts" style="font-size: 13px;">
                    <div style="margin-bottom: 8px;"><i class="fas fa-user"></i> <span id="footerManager">Хисматуллин Рустам Шафкатович</span></div>
                    <div style="margin-bottom: 8px;"><i class="fas fa-envelope"></i> <span id="footerEmail">hrs@vertum.su</span></div>
                    <div style="margin-bottom: 8px;"><i class="fas fa-phone"></i> <span id="footerPhone">+7 (985) 710-21-27</span></div>
                    <div><i class="fas fa-database"></i> <span id="footerDataInfo">Клиентов: 0 | Визитов: 0</span></div>
                </div>
            </div>
            
            <div class="footer-column">
                <h3>Быстрые ссылки</h3>
                <ul class="footer-links">
                    <li><a href="#" onclick="showSection('clients')"><i class="fas fa-users"></i> Все клиенты</a></li>
                    <li><a href="#" onclick="showSection('excelData')"><i class="fas fa-file-excel"></i> Данные Excel</a></li>
                    <li><a href="#" onclick="showCalendar()"><i class="fas fa-calendar-alt"></i> Календарь</a></li>
                    <li><a href="#" onclick="showRegistrationForm()"><i class="fas fa-user-plus"></i> Регистрация</a></li>
                    <li><a href="#" onclick="startVisit()"><i class="fas fa-play-circle"></i> Начать визит</a></li>
                    <li><a href="#" onclick="showVisitsHistory()"><i class="fas fa-history"></i> История визитов</a></li>
                </ul>
            </div>
            
            <div class="footer-column">
                <h3>Экспорт данных</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="footer-btn" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> CSV файл
                    </button>
                    <button class="footer-btn" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel файл
                    </button>
                    <button class="footer-btn" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i> Статистика
                    </button>
                </div>
                
                <h3 style="margin-top: 25px;">Системные функции</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="footer-btn" onclick="syncData()" style="font-size: 13px;">
                        <i class="fas fa-sync-alt"></i> Синхронизация
                    </button>
                    <button class="footer-btn" onclick="sendReport()" style="font-size: 13px;">
                        <i class="fas fa-paper-plane"></i> Отправить отчет
                    </button>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            © 2024 ВЕРТУМ CRM • <span id="currentDate"></span> • Версия 2.0 • 
            <span id="currentTime"></span> • <span id="systemStatus">🟢 Система активна</span>
        </div>
    </footer>

    <script>
    // ============================================
    // ПОЛНЫЙ ФУНКЦИОНАЛ CRM ВЕРТУМ
    // ============================================

    // Глобальные переменные
    let allClientsData = [];
    let filteredClientsData = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let activeVisit = null;
    let selectedClientForVisit = null;
    let visitTimer = null;
    let visitStartTime = null;
    let currentManager = {
        name: 'Хисматуллин Рустам Шафкатович',
        email: 'hrs@vertum.su',
        phone: '+7 (985) 710-21-27',
        short: 'Хисматуллин Р.Ш.'
    };

    // 1. ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Запуск ВЕРТУМ CRM v2.0...');
        
        // Инициализация системы
        initializeSystem();
        
        // Обновление даты и времени
        updateDateTime();
        
        // Проверка активного визита
        checkActiveVisit();
        
        console.log('✅ ВЕРТУМ CRM готов к работе');
    });

    function initializeSystem() {
        // Загружаем данные клиентов
        loadClientsData();
        
        // Обновляем интерфейс менеджера
        updateManagerUI();
        
        // Инициализируем фильтры
        initializeFilters();
        
        // Инициализируем календарь
        initializeCalendar();
        
        // Обновляем статистику
        updateStatistics();
        
        // Обновляем системную информацию
        updateSystemInfo();
    }

    function updateDateTime() {
        const now = new Date();
        const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit' };
        
        document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', dateOptions);
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU', timeOptions);
        
        // Обновляем каждую минуту
        setTimeout(updateDateTime, 60000);
    }

    function updateSystemInfo() {
        const systemStatus = document.getElementById('systemStatus');
        if (systemStatus) {
            systemStatus.textContent = `🟢 Система активна | 👥 ${allClientsData.length} клиентов`;
        }
        
        const footerInfo = document.getElementById('footerDataInfo');
        if (footerInfo) {
            const visits = getVisitsToday();
            footerInfo.textContent = `Клиентов: ${allClientsData.length} | Визитов сегодня: ${visits.length}`;
        }
    }

    // 2. УПРАВЛЕНИЕ ДАННЫМИ КЛИЕНТОВ
    function loadClientsData() {
        console.log('📥 Загрузка данных клиентов...');
        
        // Проверяем наличие данных в localStorage
        const savedClients = localStorage.getItem('vertum_clients');
        if (savedClients) {
            allClientsData = JSON.parse(savedClients);
        } else {
            // Загружаем тестовые данные
            loadSampleClients();
        }
        
        filteredClientsData = [...allClientsData];
        
        console.log(`✅ Загружено ${allClientsData.length} клиентов`);
        
        // Обновляем счетчики
        updateCounters();
    }

    function loadSampleClients() {
        // Тестовые данные клиентов
        const sampleClients = [
            {
                id: 1,
                code: '0780',
                name: 'Звонарев В. А. (Симферопольское ш)',
                segmentation: '2.4 Стандарт за ЦКАД (Сантех и вент)',
                region: 'Серпухов г.о.',
                businessType: 'Розничный Магазин (ДО)',
                productGroup: 'Вентиляция ДО',
                deliveryZone: 'ЗАПАД - Среда, Суббота',
                direction: 'Симферопольское ш.',
                address: 'го Серпухов, д. Калиново, Калиновский строй рынок участок 202 А',
                phone: '+7 (999) 123-45-67',
                email: 'zvonarev@example.com',
                status: 'Активен',
                lastVisit: '15.02.2024',
                manager: 'Хисматуллин Р.Ш.',
                createdAt: new Date().toISOString()
            },
            {
                id: 2,
                code: '0172',
                name: 'Петросян Г. С. (Симферопольское ш.)',
                segmentation: '2.2 Стандарт до ЦКАД (сантех и вент)',
                region: 'Новомосковский АО',
                businessType: 'Розничный Магазин (ДО)',
                productGroup: 'Вентиляция ДО',
                deliveryZone: 'ЗАПАД - Среда, Суббота',
                direction: 'Симферопольское ш.',
                address: 'Щербинка,Симферопольское ш., д. 17, ТК "Удобный", пав. Г 13',
                phone: '+7 (999) 234-56-78',
                email: 'petrosyan@example.com',
                status: 'Активен',
                lastVisit: '10.02.2024',
                manager: 'Хисматуллин Р.Ш.',
                createdAt: new Date().toISOString()
            },
            {
                id: 3,
                code: '0350',
                name: 'Васильев Б.В. (Новорижское ш)',
                segmentation: '2.5 Попутная доставка Стандарт до ЦКАД (все)',
                region: 'Красногорск г.о.',
                businessType: 'Розничный Магазин (ДО)',
                productGroup: 'Кровля ДО',
                deliveryZone: 'СЕВЕР - Вторник, Пятница',
                direction: 'Новорижское ш.',
                address: 'Красногорский р-н, Новорижское ш, 26-й км. СР Петровский, пав. Д - 51',
                phone: '+7 (999) 345-67-89',
                email: 'vasilev@example.com',
                status: 'Активен',
                lastVisit: '05.02.2024',
                manager: 'Хисматуллин Р.Ш.',
                createdAt: new Date().toISOString()
            },
            {
                id: 4,
                code: '0411',
                name: 'Балян Н.Х. (Ленинградское ш)',
                segmentation: '2.3 Стандарт за ЦКАД (все)',
                region: 'Клин г.о.',
                businessType: 'Розничный Магазин (ДО)',
                productGroup: 'Кровля ДО',
                deliveryZone: 'СЕВЕР - Вторник, Пятница',
                direction: 'Ленинградское ш.',
                address: 'г. Клин улица Чайковского д. 91 ст9',
                phone: '+7 (999) 456-78-90',
                email: 'balyan@example.com',
                status: 'Активен',
                lastVisit: '01.02.2024',
                manager: 'Хисматуллин Р.Ш.',
                createdAt: new Date().toISOString()
            },
            {
                id: 5,
                code: '0192',
                name: 'Беляев А.Ю. (Симферопольское ш)',
                segmentation: '2.1 Стандарт до ЦКАД (все)',
                region: 'Подольск г.о.',
                businessType: 'Розничный Магазин (ДО)',
                productGroup: 'Кровля ДО',
                deliveryZone: 'ЗАПАД - Среда, Суббота',
                direction: 'Симферопольское ш.',
                address: 'Подольский р-н., М-2 Крым, 36-й километр, ТК Покров пав. Л- 036',
                phone: '+7 (999) 567-89-01',
                email: 'belyaev@example.com',
                status: 'Активен',
                lastVisit: '25.01.2024',
                manager: 'Хисматуллин Р.Ш.',
                createdAt: new Date().toISOString()
            }
        ];
        
        allClientsData = sampleClients;
        saveClientsToStorage();
    }

    function saveClientsToStorage() {
        localStorage.setItem('vertum_clients', JSON.stringify(allClientsData));
    }

    function updateCounters() {
        // Обновляем счетчик клиентов
        document.getElementById('clientsCount').textContent = allClientsData.length;
        document.getElementById('statTotalClients').textContent = allClientsData.length;
        
        // Обновляем счетчик визитов сегодня
        updateVisitsToday();
        
        // Обновляем счетчик истории визитов
        updateVisitsHistoryCount();
        
        // Обновляем статистику визитов
        updateVisitsStats();
    }

    // 3. УПРАВЛЕНИЕ МЕНЕДЖЕРОМ
    function toggleManagerDropdown() {
        const dropdown = document.getElementById('managersDropdown');
        const managerSelector = document.getElementById('currentManager');
        
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
            managerSelector.classList.remove('active');
        } else {
            dropdown.style.display = 'block';
            managerSelector.classList.add('active');
        }
    }

    function selectManager(managerKey) {
        const managers = {
            'Хисматуллин': {
                name: 'Хисматуллин Рустам Шафкатович',
                email: 'hrs@vertum.su',
                phone: '+7 (985) 710-21-27',
                short: 'Хисматуллин Р.Ш.'
            },
            'Хитров': {
                name: 'Хитров Кирилл Юрьевич',
                email: 'hky@vertum.su',
                phone: '+7 (909) 624-99-00',
                short: 'Хитров К.Ю.'
            }
        };
        
        currentManager = managers[managerKey] || currentManager;
        
        // Обновляем интерфейс
        updateManagerUI();
        
        // Закрываем выпадающий список
        toggleManagerDropdown();
        
        // Обновляем активный элемент
        document.querySelectorAll('.manager-option').forEach(option => {
            option.classList.remove('active');
            if (option.textContent.includes(managerKey)) {
                option.classList.add('active');
            }
        });
        
        // Сохраняем выбор
        localStorage.setItem('vertum_current_manager', managerKey);
        
        // Уведомление
        showNotification(`Менеджер изменен на: ${currentManager.name}`, 'info');
    }

    function updateManagerUI() {
        document.getElementById('currentManagerName').textContent = currentManager.name;
        document.getElementById('currentManagerContacts').textContent = 
            `${currentManager.email} • ${currentManager.phone}`;
        
        document.getElementById('footerManager').textContent = currentManager.name;
        document.getElementById('footerEmail').textContent = currentManager.email;
        document.getElementById('footerPhone').textContent = currentManager.phone;
        
        const badge = document.getElementById('currentManagerBadge');
        if (badge) {
            badge.textContent = currentManager.short;
        }
    }

    // 4. НАВИГАЦИЯ ПО РАЗДЕЛАМ
    function showSection(sectionId) {
        // Скрываем все разделы
        document.getElementById('clientsSection').style.display = 'none';
        document.getElementById('excelDataSection').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'grid';
        document.getElementById('miniCalendar').style.display = 'block';
        
        // Сбрасываем активные карточки меню
        document.querySelectorAll('.menu-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Показываем выбранный раздел
        if (sectionId === 'clients') {
            document.getElementById('clientsSection').style.display = 'block';
            document.querySelector('[data-section="clients"]').classList.add('active');
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('miniCalendar').style.display = 'none';
            loadClientsTable();
        } else if (sectionId === 'excelData') {
            document.getElementById('excelDataSection').style.display = 'block';
            document.querySelector('[data-section="excelData"]').classList.add('active');
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('miniCalendar').style.display = 'none';
            initializeExcelSection();
        } else if (sectionId === 'main') {
            document.getElementById('mainMenu').style.display = 'grid';
            document.getElementById('miniCalendar').style.display = 'block';
        }
    }

    // 5. ФИЛЬТРЫ И ПОИСК
    function initializeFilters() {
        const filtersGrid = document.getElementById('filtersGrid');
        if (!filtersGrid) return;
        
        const filters = [
            { id: 'filterRegion', label: 'Бизнес-регион', key: 'region' },
            { id: 'filterBusinessType', label: 'Вид бизнеса', key: 'businessType' },
            { id: 'filterProductGroup', label: 'Товарная группа', key: 'productGroup' },
            { id: 'filterSegmentation', label: 'Сегментация КБ', key: 'segmentation' },
            { id: 'filterDeliveryZone', label: 'Зона доставки', key: 'deliveryZone' },
            { id: 'filterDirection', label: 'Направление', key: 'direction' },
            { id: 'filterStatus', label: 'Статус клиента', key: 'status' },
            { id: 'filterLastVisit', label: 'Последний визит', key: 'lastVisit' },
            { id: 'filterManager', label: 'Менеджер', key: 'manager' }
        ];
        
        let filtersHTML = '';
        filters.forEach(filter => {
            filtersHTML += `
                <div class="filter-item">
                    <label for="${filter.id}">${filter.label}</label>
                    <select class="filter-select" id="${filter.id}" onchange="applyFilters()">
                        <option value="">Все</option>
                    </select>
                </div>
            `;
        });
        
        filtersGrid.innerHTML = filtersHTML;
        
        // Заполняем опции фильтров уникальными значениями
        setTimeout(() => {
            filters.forEach(filter => {
                const uniqueValues = [...new Set(allClientsData.map(client => client[filter.key]).filter(Boolean))];
                const select = document.getElementById(filter.id);
                if (select) {
                    uniqueValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        select.appendChild(option);
                    });
                }
            });
        }, 100);
    }

    function applyFilters() {
        let filtered = [...allClientsData];
        
        // Применяем текстовый поиск
        const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
        if (searchTerm) {
            filtered = filtered.filter(client => 
                Object.values(client).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                )
            );
        }
        
        // Применяем выпадающие фильтры
        const filterIds = ['filterRegion', 'filterBusinessType', 'filterProductGroup', 
                          'filterSegmentation', 'filterDeliveryZone', 'filterDirection',
                          'filterStatus', 'filterLastVisit', 'filterManager'];
        
        let activeFiltersCount = 0;
        let activeFiltersHTML = '';
        
        filterIds.forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter && filter.value) {
                const filterKey = getFilterKey(filterId);
                if (filterKey) {
                    filtered = filtered.filter(client => 
                        client[filterKey] && client[filterKey] === filter.value
                    );
                    
                    activeFiltersCount++;
                    activeFiltersHTML += `
                        <div class="filter-tag">
                            ${filter.options[filter.selectedIndex].text}
                            <span class="filter-tag-remove" onclick="removeFilter('${filterId}')">×</span>
                        </div>
                    `;
                }
            }
        });
        
        filteredClientsData = filtered;
        currentPage = 1;
        
        // Обновляем активные фильтры
        const container = document.getElementById('activeFiltersContainer');
        const counter = document.getElementById('activeFiltersCount');
        
        if (activeFiltersCount > 0) {
            container.innerHTML = activeFiltersHTML;
            container.style.display = 'flex';
            counter.textContent = `Активных фильтров: ${activeFiltersCount}`;
        } else {
            container.style.display = 'none';
            counter.textContent = `Активных фильтров: 0`;
        }
        
        // Загружаем таблицу
        loadClientsTable();
        
        // Обновляем счетчик
        updateFilterCounter();
    }

    function getFilterKey(filterId) {
        const mapping = {
            'filterRegion': 'region',
            'filterBusinessType': 'businessType',
            'filterProductGroup': 'productGroup',
            'filterSegmentation': 'segmentation',
            'filterDeliveryZone': 'deliveryZone',
            'filterDirection': 'direction',
            'filterStatus': 'status',
            'filterLastVisit': 'lastVisit',
            'filterManager': 'manager'
        };
        return mapping[filterId];
    }

    function removeFilter(filterId) {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.value = '';
            applyFilters();
        }
    }

    function resetAllFilters() {
        // Сбрасываем все фильтры
        const filterIds = ['filterRegion', 'filterBusinessType', 'filterProductGroup', 
                          'filterSegmentation', 'filterDeliveryZone', 'filterDirection',
                          'filterStatus', 'filterLastVisit', 'filterManager'];
        
        filterIds.forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) filter.value = '';
        });
        
        // Сбрасываем поиск
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = '';
        
        // Применяем фильтры
        applyFilters();
        
        showNotification('Все фильтры сброшены', 'info');
    }

    function filterTable() {
        applyFilters();
    }

    function updateFilterCounter() {
        const counter = document.getElementById('filteredCount');
        if (counter) {
            counter.innerHTML = `Показано: <strong>${filteredClientsData.length}</strong> из <strong>${allClientsData.length}</strong>`;
        }
    }

    // 6. ТАБЛИЦА КЛИЕНТОВ
    function loadClientsTable() {
        const tableHead = document.getElementById('clientsTableHead');
        const tableBody = document.getElementById('clientsTableBody');
        
        if (!tableHead || !tableBody) return;
        
        // Заголовки таблицы
        const headers = [
            { key: 'code', label: 'Код', width: '80px' },
            { key: 'name', label: 'Наименование', width: '250px' },
            { key: 'region', label: 'Регион', width: '120px' },
            { key: 'businessType', label: 'Вид бизнеса', width: '150px' },
            { key: 'productGroup', label: 'Товарная группа', width: '120px' },
            { key: 'deliveryZone', label: 'Зона доставки', width: '150px' },
            { key: 'address', label: 'Адрес', width: '200px' },
            { key: 'phone', label: 'Телефон', width: '120px' },
            { key: 'status', label: 'Статус', width: '100px' },
            { key: 'lastVisit', label: 'Последний визит', width: '120px' },
            { key: 'actions', label: 'Действия', width: '150px' }
        ];
        
        let headHTML = '<tr>';
        headers.forEach(header => {
            headHTML += `<th style="min-width: ${header.width};">${header.label}</th>`;
        });
        headHTML += '</tr>';
        tableHead.innerHTML = headHTML;
        
        // Данные таблицы
        let bodyHTML = '';
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredClientsData.length);
        
        if (filteredClientsData.length === 0) {
            bodyHTML = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; color: #e9ecef; display: block;"></i>
                Клиенты не найдены
            </td></tr>`;
        } else {
            for (let i = startIndex; i < endIndex; i++) {
                const client = filteredClientsData[i];
                const globalIndex = i + 1;
                
                bodyHTML += '<tr>';
                
                headers.forEach(header => {
                    if (header.key === 'actions') {
                        bodyHTML += `
                            <td>
                                <div class="action-cell">
                                    <button class="btn-small" style="background: var(--info-color); color: white;" 
                                            onclick="callClient(${client.id})" title="Позвонить">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <button class="btn-small" style="background: var(--warning-color); color: white;" 
                                            onclick="startVisitToClient(${client.id})" title="Начать визит">
                                        <i class="fas fa-car"></i>
                                    </button>
                                    <button class="btn-small" style="background: var(--success-color); color: white;" 
                                            onclick="editClient(${client.id})" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                    } else {
                        const value = client[header.key] || '';
                        const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                        bodyHTML += `<td title="${value}">${displayValue}</td>`;
                    }
                });
                
                bodyHTML += '</tr>';
            }
        }
        
        tableBody.innerHTML = bodyHTML;
        
        // Создаем пагинацию
        createPagination();
        
        // Обновляем счетчик
        updateFilterCounter();
    }

    function createPagination() {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;
        
        const totalPages = Math.ceil(filteredClientsData.length / itemsPerPage);
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        if (currentPage > 1) {
            paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                    onclick="changePage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationHTML += '<span style="padding: 7px 10px; color: #666;">...</span>';
            }
        }
        
        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </button>`;
        }
        
        pagination.innerHTML = paginationHTML;
    }

    function changePage(page) {
        currentPage = page;
        loadClientsTable();
        
        // Прокручиваем к началу таблицы
        document.getElementById('clientsTable').scrollIntoView({ behavior: 'smooth' });
    }

    // 7. ВИЗИТЫ
    function startVisit() {
        // Проверяем активный визит
        if (activeVisit) {
            openActiveVisit();
            return;
        }
        
        // Открываем модальное окно выбора клиента
        openVisitModal('select');
    }

    function openVisitModal(step) {
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        if (step === 'select') {
            title.innerHTML = '<i class="fas fa-car"></i> ВЫБОР КЛИЕНТА ДЛЯ ВИЗИТА';
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <input type="text" 
                           style="width: 100%; padding: 12px 15px; border: 2px solid var(--primary-color); border-radius: var(--border-radius); font-size: 14px; margin-bottom: 15px;" 
                           placeholder="🔍 Поиск клиента..." 
                           id="visitClientSearch" 
                           oninput="searchClientsForVisit()">
                    
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: var(--border-radius);" 
                         id="visitClientsList">
                        ${generateClientsListForVisit()}
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeModal()" 
                            style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                        Отмена
                    </button>
                    <button onclick="proceedToVisitGoal()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                        Далее <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
        } else if (step === 'goal') {
            title.innerHTML = '<i class="fas fa-bullseye"></i> ЦЕЛЬ ВИЗИТА';
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="background: var(--light-bg); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; border: 2px solid var(--primary-color);">
                        <strong>Клиент:</strong> ${selectedClientForVisit.name || 'Клиент'}<br>
                        <strong>Код:</strong> ${selectedClientForVisit.code || '---'}<br>
                        <strong>Адрес:</strong> ${selectedClientForVisit.address || 'Не указан'}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Цель визита *</label>
                        <select class="form-input" id="visitGoalSelect">
                            <option value="">-- Выберите цель визита --</option>
                            <option value="presentation">Презентация новинок</option>
                            <option value="discussion">Обсуждение условий</option>
                            <option value="contract">Подписание договора</option>
                            <option value="meeting">Встреча</option>
                            <option value="planned">Плановый визит</option>
                            <option value="training">Обучение персонала</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Планируемая длительность (минут) *</label>
                        <input type="number" class="form-input" id="plannedDuration" min="5" max="480" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Примечания</label>
                        <textarea class="form-textarea" id="visitNotes" placeholder="Дополнительная информация..."></textarea>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; gap: 12px;">
                    <button onclick="openVisitModal('select')" 
                            style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                        <i class="fas fa-arrow-left"></i> Назад
                    </button>
                    <button onclick="startVisitProcess()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                        Начать визит
                    </button>
                </div>
            `;
        } else if (step === 'process') {
            title.innerHTML = '<i class="fas fa-play-circle"></i> ПРОЦЕСС ВИЗИТА';
            
            const goalText = getGoalText(selectedClientForVisit.visitGoal || '');
            const plannedDuration = selectedClientForVisit.plannedDuration || 60;
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #f3f0ff 0%, #e9ecef 100%); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; border: 2px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 18px; font-weight: bold; color: var(--dark-text);">${selectedClientForVisit.name || 'Клиент'}</div>
                                <div style="font-size: 13px; color: #666;">${selectedClientForVisit.address || ''}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);" id="visitTimerDisplay">00:00:00</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div><strong>Цель:</strong> ${goalText}</div>
                            <div><strong>Планируемое время:</strong> ${plannedDuration} мин</div>
                            <div><strong>Начато:</strong> ${selectedClientForVisit.visitStartTime || new Date().toLocaleTimeString('ru-RU')}</div>
                            <div><strong>Реальное время:</strong> <span id="actualTimeDisplay">00:00</span></div>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--dark-text); margin-bottom: 15px; font-size: 16px;">Результаты визита:</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="resultOrder" style="width: 16px; height: 16px;">
                            <span>Заказ оформлен</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="resultPreorder" style="width: 16px; height: 16px;">
                            <span>Предзаказ внесен</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="resultPrices" style="width: 16px; height: 16px;">
                            <span>Цены согласованы</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="resultProblems" style="width: 16px; height: 16px;">
                            <span>Проблемы решены</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Итоговое время визита (минут) *</label>
                        <input type="number" class="form-input" id="finalDuration" min="1" max="480" value="${plannedDuration}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заметки по результатам</label>
                        <textarea class="form-textarea" id="visitResultNotes" placeholder="Результаты визита..."></textarea>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; gap: 12px;">
                    <button onclick="saveVisitDraft()" 
                            style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                        <i class="fas fa-save"></i> Сохранить черновик
                    </button>
                    <button onclick="completeVisit()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                        <i class="fas fa-check-circle"></i> Завершить визит
                    </button>
                </div>
            `;
            
            // Запускаем таймер
            startVisitTimer();
        }
        
        modal.style.display = 'flex';
    }

    function generateClientsListForVisit() {
        if (allClientsData.length === 0) {
            return '<div style="text-align: center; padding: 40px; color: #666;">Нет данных клиентов</div>';
        }
        
        let html = '';
        allClientsData.slice(0, 20).forEach(client => {
            html += `
                <div class="client-item" 
                     onclick="selectClientForVisit(${client.id})"
                     id="client-${client.id}"
                     style="padding: 12px 15px; border: 1px solid #e9ecef; border-radius: var(--border-radius); margin-bottom: 8px; cursor: pointer; transition: var(--transition);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--dark-text); font-size: 14px;">${client.name}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                Код: ${client.code} • ${client.region}
                            </div>
                        </div>
                        <div style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                            Выбрать
                        </div>
                    </div>
                </div>
            `;
        });
        return html;
    }

    function selectClientForVisit(clientId) {
        // Снимаем выделение со всех
        document.querySelectorAll('.client-item').forEach(item => {
            item.style.background = 'white';
            item.style.borderColor = '#e9ecef';
        });
        
        // Выделяем выбранного
        const element = document.getElementById(`client-${clientId}`);
        if (element) {
            element.style.background = 'linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%)';
            element.style.borderColor = 'var(--primary-color)';
        }
        
        // Сохраняем выбранного клиента
        selectedClientForVisit = allClientsData.find(c => c.id === clientId);
    }

    function searchClientsForVisit() {
        const searchTerm = document.getElementById('visitClientSearch').value.toLowerCase();
        const clientsList = document.getElementById('visitClientsList');
        
        if (!searchTerm) {
            clientsList.innerHTML = generateClientsListForVisit();
            return;
        }
        
        const filteredClients = allClientsData.filter(client => 
            (client.name && client.name.toLowerCase().includes(searchTerm)) ||
            (client.code && client.code.toString().toLowerCase().includes(searchTerm)) ||
            (client.address && client.address.toLowerCase().includes(searchTerm))
        );
        
        if (filteredClients.length === 0) {
            clientsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Клиенты не найдены</div>';
            return;
        }
        
        let html = '';
        filteredClients.slice(0, 20).forEach(client => {
            html += `
                <div class="client-item" 
                     onclick="selectClientForVisit(${client.id})"
                     id="client-${client.id}"
                     style="padding: 12px 15px; border: 1px solid #e9ecef; border-radius: var(--border-radius); margin-bottom: 8px; cursor: pointer; transition: var(--transition);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--dark-text); font-size: 14px;">${client.name}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                Код: ${client.code} • ${client.region}
                            </div>
                        </div>
                        <div style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                            Выбрать
                        </div>
                    </div>
                </div>
            `;
        });
        
        clientsList.innerHTML = html;
    }

    function proceedToVisitGoal() {
        if (!selectedClientForVisit) {
            showNotification('Выберите клиента из списка', 'warning');
            return;
        }
        
        openVisitModal('goal');
    }

    function getGoalText(goalValue) {
        const goals = {
            'presentation': 'Презентация новинок',
            'discussion': 'Обсуждение условий',
            'contract': 'Подписание договора',
            'meeting': 'Встреча',
            'planned': 'Плановый визит',
            'training': 'Обучение персонала',
            'other': 'Другое'
        };
        return goals[goalValue] || goalValue;
    }

    function startVisitProcess() {
        const goalSelect = document.getElementById('visitGoalSelect');
        const goal = goalSelect.value;
        const plannedDuration = parseInt(document.getElementById('plannedDuration').value) || 60;
        const notes = document.getElementById('visitNotes')?.value || '';
        
        if (!goal) {
            showNotification('Выберите цель визита', 'warning');
            return;
        }
        
        selectedClientForVisit.visitGoal = goal;
        selectedClientForVisit.plannedDuration = plannedDuration;
        selectedClientForVisit.visitNotes = notes;
        selectedClientForVisit.visitStartTime = new Date().toLocaleTimeString('ru-RU');
        selectedClientForVisit.visitStartTimestamp = Date.now();
        
        // Создаем активный визит
        activeVisit = {
            clientId: selectedClientForVisit.id,
            clientName: selectedClientForVisit.name,
            clientCode: selectedClientForVisit.code,
            startTime: selectedClientForVisit.visitStartTime,
            startTimestamp: selectedClientForVisit.visitStartTimestamp,
            date: new Date().toLocaleDateString('ru-RU'),
            goal: goal,
            plannedDuration: plannedDuration,
            notes: notes,
            status: 'active'
        };
        
        // Сохраняем активный визит
        saveActiveVisit();
        
        // Показываем панель активного визита
        showActiveVisitBar();
        
        // Обновляем кнопку в шапке
        updateVisitButton();
        
        // Переходим к процессу визита
        openVisitModal('process');
        
        showNotification(`Визит начат: ${selectedClientForVisit.name}`, 'info');
    }

    function startVisitTimer() {
        if (!selectedClientForVisit || !selectedClientForVisit.visitStartTimestamp) return;
        
        visitStartTime = selectedClientForVisit.visitStartTimestamp;
        
        function updateTimer() {
            if (!visitStartTime) return;
            
            const now = Date.now();
            const elapsed = now - visitStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            // Обновляем отображение таймера
            const timerDisplay = document.getElementById('visitTimerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = 
                    `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
            }
            
            // Обновляем отображение реального времени
            const actualTimeDisplay = document.getElementById('actualTimeDisplay');
            if (actualTimeDisplay) {
                actualTimeDisplay.textContent = `${minutes} минут`;
            }
            
            // Обновляем отображение в панели активного визита
            const durationDisplay = document.getElementById('activeVisitDuration');
            if (durationDisplay && activeVisit) {
                if (hours > 0) {
                    durationDisplay.textContent = `${hours}ч ${minutes % 60}м`;
                } else {
                    durationDisplay.textContent = `${minutes} минут`;
                }
            }
            
            // Обновляем поле итогового времени
            const finalDurationInput = document.getElementById('finalDuration');
            if (finalDurationInput) {
                finalDurationInput.value = minutes;
            }
        }
        
        // Обновляем сразу
        updateTimer();
        
        // Запускаем интервал
        visitTimer = setInterval(updateTimer, 1000);
    }

    function stopVisitTimer() {
        if (visitTimer) {
            clearInterval(visitTimer);
            visitTimer = null;
        }
        visitStartTime = null;
    }

    function showActiveVisitBar() {
        const bar = document.getElementById('activeVisitBar');
        const clientSpan = document.getElementById('activeVisitClient');
        const timeSpan = document.getElementById('activeVisitTime');
        
        if (activeVisit) {
            clientSpan.textContent = activeVisit.clientName || 'Клиент';
            timeSpan.textContent = activeVisit.startTime;
            bar.style.display = 'block';
        }
    }

    function saveActiveVisit() {
        localStorage.setItem('vertum_active_visit', JSON.stringify(activeVisit));
    }

    function checkActiveVisit() {
        const savedVisit = localStorage.getItem('vertum_active_visit');
        if (savedVisit) {
            activeVisit = JSON.parse(savedVisit);
            
            // Восстанавливаем данные клиента
            if (activeVisit.clientId) {
                selectedClientForVisit = allClientsData.find(c => c.id === activeVisit.clientId);
            }
            
            if (activeVisit.status === 'active') {
                showActiveVisitBar();
                updateVisitButton();
            }
        }
    }

    function openActiveVisit() {
        if (activeVisit && activeVisit.status === 'active') {
            openVisitModal('process');
        }
    }

    function updateVisitButton() {
        const btn = document.getElementById('startVisitBtn');
        if (activeVisit && activeVisit.status === 'active') {
            btn.innerHTML = '<i class="fas fa-car"></i> ВИЗИТ ИДЁТ';
            btn.style.background = 'linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%)';
        } else {
            btn.innerHTML = '<i class="fas fa-play-circle"></i> НАЧАТЬ ВИЗИТ';
            btn.style.background = 'linear-gradient(135deg, var(--warning-color) 0%, #F57C00 100%)';
        }
    }

    function saveVisitDraft() {
        if (!activeVisit) return;
        
        const results = [];
        ['resultOrder', 'resultPreorder', 'resultPrices', 'resultProblems'].forEach(id => {
            if (document.getElementById(id)?.checked) {
                results.push(id.replace('result', '').toLowerCase());
            }
        });
        
        const finalDuration = parseInt(document.getElementById('finalDuration')?.value) || 
                              activeVisit.plannedDuration || 60;
        const resultNotes = document.getElementById('visitResultNotes')?.value || '';
        
        // Сохраняем черновик
        localStorage.setItem('visit_draft', JSON.stringify({
            visitId: activeVisit.clientId,
            results: results,
            notes: resultNotes,
            duration: finalDuration,
            timestamp: new Date().toISOString()
        }));
        
        showNotification('Черновик визита сохранен', 'info');
    }

    function completeVisit() {
        if (!activeVisit) return;
        
        const results = [];
        ['resultOrder', 'resultPreorder', 'resultPrices', 'resultProblems'].forEach(id => {
            if (document.getElementById(id)?.checked) {
                results.push(id.replace('result', '').toLowerCase());
            }
        });
        
        const finalDuration = parseInt(document.getElementById('finalDuration')?.value) || 
                              activeVisit.plannedDuration || 60;
        const resultNotes = document.getElementById('visitResultNotes')?.value || '';
        const today = new Date().toLocaleDateString('ru-RU');
        const endTime = new Date().toLocaleTimeString('ru-RU');
        
        // Создаем завершенный визит
        const completedVisit = {
            ...activeVisit,
            endTime: endTime,
            duration: finalDuration,
            status: 'completed',
            results: results,
            resultNotes: resultNotes,
            completedAt: new Date().toISOString()
        };
        
        // Сохраняем визит
        saveVisit(completedVisit);
        
        // Обновляем дату последнего визита у клиента
        if (selectedClientForVisit) {
            selectedClientForVisit.lastVisit = today;
            saveClientsToStorage();
        }
        
        // Закрываем модальное окно
        closeModal();
        
        // Скрываем панель активного визита
        document.getElementById('activeVisitBar').style.display = 'none';
        
        // Сбрасываем активный визит
        activeVisit = null;
        selectedClientForVisit = null;
        localStorage.removeItem('vertum_active_visit');
        
        // Обновляем счетчики
        updateVisitsToday();
        updateVisitsHistoryCount();
        updateVisitsStats();
        updateVisitButton();
        
        // Останавливаем таймер
        stopVisitTimer();
        
        showNotification(`✅ Визит завершен. Длительность: ${finalDuration} мин.`, 'info');
    }

    function saveVisit(visit) {
        const visits = getVisitsByDate(visit.date);
        visits.push(visit);
        localStorage.setItem(`vertum_visits_${visit.date}`, JSON.stringify(visits));
    }

    function getVisitsByDate(date) {
        return JSON.parse(localStorage.getItem(`vertum_visits_${date}`) || '[]');
    }

    function getVisitsToday() {
        const today = new Date().toLocaleDateString('ru-RU');
        return getVisitsByDate(today);
    }

    function getAllVisits() {
        let allVisits = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('vertum_visits_')) {
                const visits = JSON.parse(localStorage.getItem(key) || '[]');
                allVisits = [...allVisits, ...visits];
            }
        }
        return allVisits;
    }

    function updateVisitsToday() {
        const visits = getVisitsToday();
        document.getElementById('visitsToday').textContent = visits.filter(v => v.status === 'completed').length;
    }

    function updateVisitsHistoryCount() {
        const allVisits = getAllVisits();
        document.getElementById('visitsHistoryCount').textContent = allVisits.filter(v => v.status === 'completed').length;
    }

    function updateVisitsStats() {
        const allVisits = getAllVisits();
        const completedVisits = allVisits.filter(v => v.status === 'completed');
        document.getElementById('statVisitsCount').textContent = completedVisits.length;
    }

    function startVisitToClient(clientId) {
        const client = allClientsData.find(c => c.id === clientId);
        if (client) {
            selectedClientForVisit = client;
            openVisitModal('goal');
        }
    }

    function startVisitFromTable() {
        showNotification('Для начала визита выбранным клиентам выделите их в таблице', 'info');
    }

    // 8. РЕГИСТРАЦИЯ КЛИЕНТА
    function showRegistrationForm() {
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-user-plus"></i> РЕГИСТРАЦИЯ НОВОГО КЛИЕНТА';
        
        content.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Код клиента *</label>
                        <input type="text" class="form-input" id="regCode" placeholder="Например: 0999">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Наименование *</label>
                        <input type="text" class="form-input" id="regName" placeholder="Полное наименование">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Бизнес-регион *</label>
                        <select class="form-input" id="regRegion">
                            <option value="">Выберите регион</option>
                            <option value="Серпухов г.о.">Серпухов г.о.</option>
                            <option value="Новомосковский АО">Новомосковский АО</option>
                            <option value="Красногорск г.о.">Красногорск г.о.</option>
                            <option value="Клин г.о.">Клин г.о.</option>
                            <option value="Подольск г.о.">Подольск г.о.</option>
                            <option value="Одинцовский г.о.">Одинцовский г.о.</option>
                            <option value="Химки г.о.">Химки г.о.</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Вид бизнеса *</label>
                        <select class="form-input" id="regBusinessType">
                            <option value="">Выберите вид бизнеса</option>
                            <option value="Розничный Магазин (ДО)">Розничный Магазин (ДО)</option>
                            <option value="Производитель (ДО)">Производитель (ДО)</option>
                            <option value="Интернет Магазин (ДО)">Интернет Магазин (ДО)</option>
                            <option value="Оптовый склад">Оптовый склад</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Товарная группа *</label>
                        <select class="form-input" id="regProductGroup">
                            <option value="">Выберите группу</option>
                            <option value="Вентиляция ДО">Вентиляция ДО</option>
                            <option value="Кровля ДО">Кровля ДО</option>
                            <option value="Сантехника ДО">Сантехника ДО</option>
                            <option value="Фасадные системы">Фасадные системы</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Телефон</label>
                        <input type="tel" class="form-input" id="regPhone" placeholder="+7 (999) 999-99-99">
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Адрес</label>
                        <input type="text" class="form-input" id="regAddress" placeholder="Полный адрес">
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="regEmail" placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Примечания</label>
                        <textarea class="form-textarea" id="regNotes" placeholder="Дополнительная информация..."></textarea>
                    </div>
                </div>
                
                <div style="background: var(--light-bg); padding: 15px; border-radius: var(--border-radius); margin-bottom: 15px;">
                    <div style="font-weight: 600; color: var(--dark-text); margin-bottom: 5px;">Менеджер:</div>
                    <div>${currentManager.name}</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeModal()" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    Отмена
                </button>
                <button onclick="registerNewClient()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-save"></i> Зарегистрировать
                </button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function registerNewClient() {
        const code = document.getElementById('regCode')?.value.trim();
        const name = document.getElementById('regName')?.value.trim();
        const region = document.getElementById('regRegion')?.value;
        const businessType = document.getElementById('regBusinessType')?.value;
        const productGroup = document.getElementById('regProductGroup')?.value;
        
        // Проверка обязательных полей
        if (!code || !name || !region || !businessType || !productGroup) {
            showNotification('Заполните обязательные поля (помечены *)', 'warning');
            return;
        }
        
        // Генерируем ID
        const newId = allClientsData.length > 0 ? Math.max(...allClientsData.map(c => c.id)) + 1 : 1;
        
        // Создаем нового клиента
        const newClient = {
            id: newId,
            code: code,
            name: name,
            segmentation: '2.0 Новый клиент',
            region: region,
            businessType: businessType,
            productGroup: productGroup,
            deliveryZone: 'НЕ ОПРЕДЕЛЕНО',
            direction: 'НЕ ОПРЕДЕЛЕНО',
            address: document.getElementById('regAddress')?.value.trim() || '',
            phone: document.getElementById('regPhone')?.value.trim() || '',
            email: document.getElementById('regEmail')?.value.trim() || '',
            notes: document.getElementById('regNotes')?.value.trim() || '',
            status: 'Новый',
            lastVisit: '',
            manager: currentManager.name,
            createdAt: new Date().toISOString()
        };
        
        // Добавляем клиента
        allClientsData.push(newClient);
        saveClientsToStorage();
        
        // Обновляем отображение
        filteredClientsData = [...allClientsData];
        updateCounters();
        updateSystemInfo();
        
        // Закрываем модальное окно
        closeModal();
        
        // Показываем уведомление
        showNotification(`Клиент "${name}" зарегистрирован! Код: ${code}`, 'info');
        
        // Показываем раздел с клиентами
        showSection('clients');
    }

    // 9. КАЛЕНДАРЬ
    function showCalendar() {
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-calendar-alt"></i> КАЛЕНДАРЬ ВСТРЕЧ И ВИЗИТОВ';
        
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        content.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-weight: 600; font-size: 18px; color: var(--dark-text);" id="calendarTitle">
                        ${getMonthName(currentMonth)} ${currentYear}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="changeCalendarMonth(-1)" 
                                style="padding: 8px 15px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="changeCalendarMonth(1)" 
                                style="padding: 8px 15px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div id="calendarContainer">
                    ${generateCalendar(currentMonth, currentYear)}
                </div>
                
                <div style="margin-top: 25px;">
                    <h4 style="color: var(--dark-text); margin-bottom: 15px; font-size: 16px;">
                        <i class="fas fa-calendar-check"></i> Ближайшие события
                    </h4>
                    <div id="eventsList">
                        ${generateEventsList()}
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="addCalendarEvent()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-plus"></i> Добавить событие
                </button>
                <button onclick="closeModal()" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    Закрыть
                </button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function getMonthName(month) {
        const months = [
            'ЯНВАРЬ', 'ФЕВРАЛЬ', 'МАРТ', 'АПРЕЛЬ', 'МАЙ', 'ИЮНЬ',
            'ИЮЛЬ', 'АВГУСТ', 'СЕНТЯБРЬ', 'ОКТЯБРЬ', 'НОЯБРЬ', 'ДЕКАБРЬ'
        ];
        return months[month];
    }

    function generateCalendar(month, year) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();
        
        let calendarHTML = `
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px;">
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Пн</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Вт</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Ср</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Чт</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Пт</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Сб</div>
                <div style="text-align: center; font-weight: 600; color: var(--primary-color); padding: 12px; background: var(--light-bg); border-radius: var(--border-radius);">Вс</div>
        `;
        
        // Пустые ячейки до первого дня месяца
        for (let i = 0; i < (startingDay === 0 ? 6 : startingDay - 1); i++) {
            calendarHTML += '<div style="padding: 15px; background: #f8f9fa; border-radius: var(--border-radius);"></div>';
        }
        
        // Дни месяца
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const isWeekend = (startingDay + day - 1) % 7 >= 5;
            
            let dayClass = 'calendar-day';
            let dayStyle = `padding: 15px; text-align: center; cursor: pointer; border-radius: var(--border-radius); font-weight: 600;`;
            
            if (isToday) {
                dayStyle += `background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white;`;
            } else if (isWeekend) {
                dayStyle += `background: #f3f0ff; color: var(--secondary-color);`;
            } else {
                dayStyle += `background: white; color: var(--dark-text);`;
            }
            
            calendarHTML += `
                <div style="${dayStyle}" onclick="selectCalendarDate(${day}, ${month}, ${year})">
                    ${day}
                    ${day === 20 ? '<div style="font-size: 10px; margin-top: 3px; color: var(--warning-color);">🎂</div>' : ''}
                    ${day === 21 ? '<div style="font-size: 10px; margin-top: 3px; color: var(--info-color);">👥</div>' : ''}
                    ${day === 25 ? '<div style="font-size: 10px; margin-top: 3px; color: var(--success-color);">📊</div>' : ''}
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        return calendarHTML;
    }

    function generateEventsList() {
        const events = [
            { date: '20 февраля', title: 'День рождения клиента', client: 'Петросян Г.С.', type: 'birthday' },
            { date: '21 февраля, 14:30', title: 'Встреча с клиентом', client: 'Звонарев В.А.', type: 'meeting' },
            { date: '25 февраля, 11:00', title: 'Презентация новинок', client: 'Все клиенты', type: 'presentation' }
        ];
        
        let html = '';
        events.forEach(event => {
            html += `
                <div style="border-left: 4px solid var(--primary-color); padding: 12px 15px; margin-bottom: 10px; background: white; border-radius: var(--border-radius);">
                    <div style="font-weight: 600; color: var(--dark-text);">${event.title}</div>
                    <div style="font-size: 13px; color: #666; margin-top: 3px;">
                        <i class="fas fa-calendar"></i> ${event.date} • 
                        <i class="fas fa-user"></i> ${event.client}
                    </div>
                </div>
            `;
        });
        
        return html;
    }

    function changeCalendarMonth(delta) {
        showNotification('Переключение месяцев календаря', 'info');
    }

    function selectCalendarDate(day, month, year) {
        showNotification(`Выбрана дата: ${day}.${month + 1}.${year}`, 'info');
    }

    function addCalendarEvent() {
        showNotification('Добавление события в календарь', 'info');
    }


    function changeCalendarMonth(delta) {
        showNotification(\`Переключение месяцев календаря на \${delta} месяц\`, 'info');
        // Здесь должна быть логика перерисовки календаря
    }

    function selectCalendarDate(day, month, year) {
        // Открываем модальное окно для создания события
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-calendar-plus"></i> СОБЫТИЕ НА КАЛЕНДАРЕ';
        
        const dateStr = \`\${day}.\${month + 1}.\${year}\`;
        
        content.innerHTML = \`
            <div style="margin-bottom: 25px;">
                <div style="background: var(--light-bg); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; border: 2px solid var(--primary-color);">
                    <strong>Дата:</strong> \${dateStr}<br>
                    <strong>Менеджер:</strong> \${currentManager.name}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Название события *</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Встреча, звонок, визит...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Время</label>
                    <input type="time" class="form-input" id="eventTime" value="10:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Клиент (если есть)</label>
                    <select class="form-input" id="eventClient">
                        <option value="">Без привязки к клиенту</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="eventDescription" placeholder="Детали события..."></textarea>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeModal()" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    Отмена
                </button>
                <button onclick="saveCalendarEvent('\${dateStr}')" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-save"></i> Сохранить событие
                </button>
            </div>
        \`;
        
        // Заполняем список клиентов
        setTimeout(() => {
            const clientSelect = document.getElementById('eventClient');
            allClientsData.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = \`\${client.name} (\${client.code})\`;
                clientSelect.appendChild(option);
            });
        }, 100);
        
        modal.style.display = 'flex';
    }

    function addCalendarEvent() {
        const today = new Date();
        selectCalendarDate(today.getDate(), today.getMonth(), today.getFullYear());
    }

    function saveCalendarEvent(dateStr) {
        const title = document.getElementById('eventTitle')?.value.trim();
        const time = document.getElementById('eventTime')?.value;
        const clientId = document.getElementById('eventClient')?.value;
        const description = document.getElementById('eventDescription')?.value.trim();
        
        if (!title) {
            showNotification('Введите название события', 'warning');
            return;
        }
        
        const client = clientId ? allClientsData.find(c => c.id == clientId) : null;
        
        // Сохраняем событие
        const events = JSON.parse(localStorage.getItem('vertum_calendar_events') || '[]');
        events.push({
            id: Date.now(),
            date: dateStr,
            title: title,
            time: time,
            clientId: clientId,
            clientName: client ? client.name : '',
            description: description,
            createdBy: currentManager.name,
            createdAt: new Date().toISOString()
        });
        
        localStorage.setItem('vertum_calendar_events', JSON.stringify(events));
        
        showNotification(\`Событие "\${title}" сохранено на \${dateStr}\`, 'success');
        closeModal();
    }

    function initializeCalendar() {
        // Инициализация мини-календаря
        const miniCalendar = document.getElementById('miniCalendar');
        if (miniCalendar) {
            // Можно добавить динамическое заполнение календаря
        }
    }

    // 10. ИСТОРИЯ ВИЗИТОВ
    function showVisitsHistory() {
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-history"></i> ИСТОРИЯ ВИЗИТОВ';
        
        const allVisits = getAllVisits().filter(v => v.status === 'completed');
        
        content.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: var(--dark-text);">
                        Всего визитов: <span style="color: var(--primary-color);">${allVisits.length}</span>
                    </div>
                    <input type="text" 
                           style="padding: 10px 15px; border: 2px solid var(--primary-color); border-radius: var(--border-radius); font-size: 14px; width: 300px;" 
                           placeholder="🔍 Поиск по клиентам, датам..." 
                           id="historySearch" 
                           oninput="filterVisitsHistory()">
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;" id="visitsHistoryList">
                    ${generateVisitsHistoryList(allVisits)}
                </div>
                
                ${allVisits.length === 0 ? `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px; color: #e9ecef;"></i>
                        <div style="font-size: 16px; margin-bottom: 5px;">История визитов пуста</div>
                        <div style="font-size: 13px;">Начните первый визит через меню "Начать визит"</div>
                    </div>
                ` : ''}
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="exportVisitsHistory()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-download"></i> Экспорт истории
                </button>
                <button onclick="closeModal()" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    Закрыть
                </button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function generateVisitsHistoryList(visits) {
        if (visits.length === 0) return '';
        
        // Сортируем по дате (новые сначала)
        visits.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
        
        let html = '';
        visits.forEach(visit => {
            const duration = visit.duration || '?';
            const goal = getGoalText(visit.goal || '');
            
            html += `
                <div style="border: 1px solid #e9ecef; border-radius: var(--border-radius); padding: 15px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600; color: var(--dark-text); font-size: 15px;">${visit.clientName}</div>
                            <div style="font-size: 13px; color: #666;">Код: ${visit.clientCode} • ${visit.date}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            ${duration} мин
                        </div>
                    </div>
                    
                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                        <i class="fas fa-bullseye"></i> ${goal} • 
                        <i class="fas fa-clock"></i> ${visit.startTime} - ${visit.endTime}
                    </div>
                    
                    ${visit.resultNotes ? `
                        <div style="font-size: 13px; color: #444; background: var(--light-bg); padding: 10px; border-radius: var(--border-radius); margin-top: 8px; border-left: 3px solid var(--primary-color);">
                            ${visit.resultNotes}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        return html;
    }

    function filterVisitsHistory() {
        const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
        const historyList = document.getElementById('visitsHistoryList');
        
        const allVisits = getAllVisits().filter(v => v.status === 'completed');
        
        if (!searchTerm) {
            historyList.innerHTML = generateVisitsHistoryList(allVisits);
            return;
        }
        
        const filteredVisits = allVisits.filter(visit => 
            (visit.clientName?.toLowerCase().includes(searchTerm)) ||
            (visit.clientCode?.toString().toLowerCase().includes(searchTerm)) ||
            (visit.date?.toLowerCase().includes(searchTerm)) ||
            (visit.goal?.toLowerCase().includes(searchTerm)) ||
            (visit.resultNotes?.toLowerCase().includes(searchTerm))
        );
        
        historyList.innerHTML = generateVisitsHistoryList(filteredVisits);
    }

    // 11. EXCEL ФУНКЦИОНАЛ
    function initializeExcelSection() {
        const sheetSelect = document.getElementById('excelSheetSelect');
        if (!sheetSelect) return;
        
        // Очищаем и заполняем список листов
        sheetSelect.innerHTML = '<option value="">Выберите лист Excel...</option>';
        
        const sheets = [
            { name: 'Клиенты', rows: allClientsData.length },
            { name: 'Визиты', rows: getAllVisits().length },
            { name: 'Статистика', rows: 10 },
            { name: 'Отчеты', rows: 5 }
        ];
        
        sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = `${sheet.name} (${sheet.rows} записей)`;
            sheetSelect.appendChild(option);
        });
        
        // Загружаем лист по умолчанию
        if (sheets.length > 0) {
            loadExcelSheet(sheets[0].name);
        }
    }

    function loadExcelSheet(sheetName) {
        const select = document.getElementById('excelSheetSelect');
        if (select) {
            select.value = sheetName;
        }
        
        let data = [];
        let headers = [];
        
        if (sheetName === 'Клиенты') {
            if (allClientsData.length > 0) {
                headers = Object.keys(allClientsData[0]);
                data = allClientsData;
            }
        } else if (sheetName === 'Визиты') {
            const visits = getAllVisits();
            if (visits.length > 0) {
                headers = Object.keys(visits[0]);
                data = visits;
            }
        } else {
            data = [{ message: 'Данные для этого листа отсутствуют' }];
            headers = ['message'];
        }
        
        // Обновляем статистику
        document.getElementById('currentSheetName').textContent = sheetName;
        document.getElementById('excelRowCount').textContent = data.length;
        document.getElementById('excelColCount').textContent = headers.length;
        document.getElementById('excelUpdateTime').textContent = new Date().toLocaleTimeString('ru-RU');
        document.getElementById('excelCount').innerHTML = `Загружено: <strong>${data.length}</strong> записей`;
        
        // Отображаем данные в таблице
        displayExcelData(data, headers);
    }

    function displayExcelData(data, headers) {
        const tableHead = document.getElementById('excelTableHead');
        const tableBody = document.getElementById('excelTableBody');
        
        if (!tableHead || !tableBody) return;
        
        // Заголовки
        let headHTML = '<tr>';
        headers.forEach(header => {
            headHTML += `<th>${header}</th>`;
        });
        headHTML += '</tr>';
        tableHead.innerHTML = headHTML;
        
        // Данные
        let bodyHTML = '';
        const displayData = data.slice(0, 50); // Ограничиваем 50 записями для производительности
        
        if (displayData.length === 0) {
            bodyHTML = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #666;">
                Нет данных для отображения
            </td></tr>`;
        } else {
            displayData.forEach(row => {
                bodyHTML += '<tr>';
                headers.forEach(header => {
                    const value = row[header] !== undefined ? row[header] : '';
                    const displayValue = typeof value === 'string' && value.length > 50 ? 
                        value.substring(0, 50) + '...' : 
                        String(value);
                    bodyHTML += `<td title="${value}">${displayValue}</td>`;
                });
                bodyHTML += '</tr>';
            });
        }
        
        tableBody.innerHTML = bodyHTML;
        
        if (data.length > 50) {
            const infoRow = document.createElement('tr');
            infoRow.innerHTML = `<td colspan="${headers.length}" style="text-align: center; color: #666; padding: 15px;">
                Показано 50 из ${data.length} записей
            </td>`;
            tableBody.appendChild(infoRow);
        }
    }

    function searchExcelData() {
        const searchTerm = document.getElementById('excelSearchInput')?.value.toLowerCase() || '';
        const sheetName = document.getElementById('excelSheetSelect')?.value;
        
        if (!searchTerm || !sheetName) {
            loadExcelSheet(sheetName);
            return;
        }
        
        let data = [];
        let headers = [];
        
        if (sheetName === 'Клиенты') {
            data = allClientsData.filter(client => 
                Object.values(client).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                )
            );
            if (data.length > 0) {
                headers = Object.keys(data[0]);
            }
        } else if (sheetName === 'Визиты') {
            const visits = getAllVisits();
            data = visits.filter(visit => 
                Object.values(visit).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                )
            );
            if (data.length > 0) {
                headers = Object.keys(data[0]);
            }
        }
        
        // Обновляем статистику
        document.getElementById('excelRowCount').textContent = data.length;
        document.getElementById('excelCount').innerHTML = `Найдено: <strong>${data.length}</strong> записей`;
        
        // Отображаем результаты
        displayExcelData(data, headers);
    }

    function refreshExcelData() {
        const sheetName = document.getElementById('excelSheetSelect')?.value;
        if (sheetName) {
            loadExcelSheet(sheetName);
            showNotification('Данные Excel обновлены', 'info');
        }
    }

    function importExcelFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Обработка данных Excel
                    processExcelData(workbook);
                    
                    showNotification(`Файл "${file.name}" успешно загружен`, 'info');
                } catch (error) {
                    showNotification('Ошибка при чтении файла Excel', 'error');
                    console.error('Excel import error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        };
        
        input.click();
    }

    function processExcelData(workbook) {
        // Здесь можно добавить логику обработки данных Excel
        console.log('Excel workbook loaded:', workbook);
        
        // Пример: получаем первый лист
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        console.log('Data from Excel:', jsonData);
        
        // Можно преобразовать данные и добавить в систему
        // Например, импорт новых клиентов
    }

    function exportExcelToCSV() {
        const sheetName = document.getElementById('excelSheetSelect')?.value;
        if (!sheetName) {
            showNotification('Выберите лист для экспорта', 'warning');
            return;
        }
        
        let data = [];
        let filename = '';
        
        if (sheetName === 'Клиенты') {
            data = allClientsData;
            filename = `clients_${new Date().toISOString().split('T')[0]}.csv`;
        } else if (sheetName === 'Визиты') {
            data = getAllVisits();
            filename = `visits_${new Date().toISOString().split('T')[0]}.csv`;
        } else {
            showNotification('Нет данных для экспорта', 'warning');
            return;
        }
        
        if (data.length === 0) {
            showNotification('Нет данных для экспорта', 'warning');
            return;
        }
        
        // Создаем CSV
        const headers = Object.keys(data[0]);
        const csvRows = [];
        
        csvRows.push(headers.join(';'));
        
        data.forEach(row => {
            const values = headers.map(header => {
                const value = row[header] !== undefined ? row[header] : '';
                return `"${String(value).replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(';'));
        });
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`Экспортировано ${data.length} записей в CSV`, 'info');
    }

    // 12. ЭКСПОРТ ДАННЫХ
    function exportCSV() {
        if (filteredClientsData.length === 0) {
            showNotification('Нет данных для экспорта', 'warning');
            return;
        }
        
        try {
            const headers = Object.keys(filteredClientsData[0]);
            const csvRows = [];
            
            csvRows.push(headers.join(';'));
            
            filteredClientsData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] !== undefined ? row[header] : '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(';'));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clients_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Экспортировано ${filteredClientsData.length} клиентов в CSV`, 'info');
        } catch (error) {
            showNotification('Ошибка при экспорте данных', 'error');
            console.error('Export error:', error);
        }
    }

    function exportToExcel() {
        if (filteredClientsData.length === 0) {
            showNotification('Нет данных для экспорта', 'warning');
            return;
        }
        
        try {
            // Создаем книгу Excel
            const workbook = {
                SheetNames: ['Клиенты', 'Статистика'],
                Sheets: {
                    'Клиенты': createExcelSheet(filteredClientsData),
                    'Статистика': createStatsSheet()
                }
            };
            
            // Генерируем файл
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });
            
            // Сохраняем файл
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ВЕРТУМ_Клиенты_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Экспортировано ${filteredClientsData.length} клиентов в Excel`, 'info');
        } catch (error) {
            console.error('Ошибка экспорта Excel:', error);
            showNotification('Ошибка при экспорте в Excel. Попробуйте экспорт в CSV.', 'error');
        }
    }

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    function createExcelSheet(data) {
        if (data.length === 0) {
            return XLSX.utils.aoa_to_sheet([['Нет данных']]);
        }
        
        const headers = Object.keys(data[0]);
        const wsData = [
            headers,
            ...data.map(row => headers.map(header => row[header] || ''))
        ];
        
        return XLSX.utils.aoa_to_sheet(wsData);
    }

    function createStatsSheet() {
        const statsData = [
            ['Статистика ВЕРТУМ CRM', '', '', ''],
            ['Дата отчета', new Date().toLocaleDateString('ru-RU'), '', ''],
            ['Менеджер', currentManager.name, '', ''],
            ['', '', '', ''],
            ['Показатель', 'Значение', 'Цель', 'Выполнение'],
            ['Всего клиентов', allClientsData.length, '150', `${Math.round(allClientsData.length / 150 * 100)}%`],
            ['Визитов сегодня', getVisitsToday().filter(v => v.status === 'completed').length, '5', '—'],
            ['Всего визитов', getAllVisits().filter(v => v.status === 'completed').length, '50', '—'],
            ['Активных клиентов', allClientsData.filter(c => c.status === 'Активен').length, '120', '—'],
            ['Новых клиентов', allClientsData.filter(c => c.status === 'Новый').length, '30', '—']
        ];
        
        return XLSX.utils.aoa_to_sheet(statsData);
    }

    function exportVisitsHistory() {
        const allVisits = getAllVisits().filter(v => v.status === 'completed');
        
        if (allVisits.length === 0) {
            showNotification('Нет данных для экспорта', 'warning');
            return;
        }
        
        try {
            // Создаем CSV
            const headers = ['Дата', 'Клиент', 'Код клиента', 'Цель', 'Длительность (мин)', 'Начало', 'Окончание', 'Результаты', 'Заметки', 'Менеджер'];
            const csvRows = [];
            
            csvRows.push(headers.join(';'));
            
            allVisits.forEach(visit => {
                const row = [
                    visit.date || '',
                    visit.clientName || '',
                    visit.clientCode || '',
                    getGoalText(visit.goal || ''),
                    visit.duration || '',
                    visit.startTime || '',
                    visit.endTime || '',
                    visit.results?.join(', ') || '',
                    visit.resultNotes || '',
                    currentManager.name
                ];
                
                const values = row.map(value => 
                    `"${String(value).replace(/"/g, '""')}"`
                );
                csvRows.push(values.join(';'));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `visits_history_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Экспортировано ${allVisits.length} визитов`, 'info');
        } catch (error) {
            showNotification('Ошибка при экспорте истории', 'error');
            console.error('Export history error:', error);
        }
    }

    // 13. ОТЧЕТЫ
    function generateReport() {
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-chart-bar"></i> ОТЧЕТ ПО ДЕЯТЕЛЬНОСТИ';
        
        const today = new Date().toLocaleDateString('ru-RU');
        const visitsToday = getVisitsToday().filter(v => v.status === 'completed').length;
        const allVisits = getAllVisits().filter(v => v.status === 'completed').length;
        const activeClients = allClientsData.filter(c => c.status === 'Активен').length;
        const newClients = allClientsData.filter(c => c.status === 'Новый').length;
        
        content.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%); padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px; border: 2px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--dark-text); margin-bottom: 15px; font-size: 18px;">СВОДНАЯ СТАТИСТИКА</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: var(--border-radius); border-left: 4px solid var(--primary-color);">
                            <div style="font-size: 24px; font-weight: bold; color: var(--dark-text);">${allClientsData.length}</div>
                            <div style="font-size: 13px; color: #666;">Всего клиентов</div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: var(--border-radius); border-left: 4px solid var(--success-color);">
                            <div style="font-size: 24px; font-weight: bold; color: var(--dark-text);">${activeClients}</div>
                            <div style="font-size: 13px; color: #666;">Активных клиентов</div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: var(--border-radius); border-left: 4px solid var(--warning-color);">
                            <div style="font-size: 24px; font-weight: bold; color: var(--dark-text);">${visitsToday}</div>
                            <div style="font-size: 13px; color: #666;">Визитов сегодня</div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: var(--border-radius); border-left: 4px solid var(--info-color);">
                            <div style="font-size: 24px; font-weight: bold; color: var(--dark-text);">${allVisits}</div>
                            <div style="font-size: 13px; color: #666;">Всего визитов</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email для отправки отчета *</label>
                    <input type="email" class="form-input" id="reportEmail" value="${currentManager.email}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Комментарий к отчету</label>
                    <textarea class="form-textarea" id="reportComment" placeholder="Дополнительная информация..."></textarea>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 12px;">
                <button onclick="previewReport()" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-eye"></i> Предпросмотр
                </button>
                <button onclick="sendEmailReport()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-paper-plane"></i> Отправить отчет
                </button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function previewReport() {
        const today = new Date().toLocaleDateString('ru-RU');
        const email = document.getElementById('reportEmail')?.value || currentManager.email;
        const comment = document.getElementById('reportComment')?.value || '';
        
        const previewWindow = window.open('', '_blank');
        previewWindow.document.write(`
            <html>
            <head>
                <title>Предпросмотр отчета ВЕРТУМ CRM</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
                    h1 { color: #2d3748; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                    .section { margin: 25px 0; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; }
                    .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
                    .stat-item { padding: 15px; background: #f8f9fa; border-radius: 6px; }
                    .stat-value { font-size: 24px; font-weight: bold; color: #2d3748; }
                    .stat-label { font-size: 13px; color: #666; margin-top: 5px; }
                    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef; color: #666; font-size: 13px; }
                </style>
            </head>
            <body>
                <h1>ОТЧЕТ ВЕРТУМ CRM</h1>
                
                <div class="section">
                    <h3>📊 ОБЩАЯ СТАТИСТИКА</h3>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value">${allClientsData.length}</div>
                            <div class="stat-label">Всего клиентов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${allClientsData.filter(c => c.status === 'Активен').length}</div>
                            <div class="stat-label">Активных клиентов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${getVisitsToday().filter(v => v.status === 'completed').length}</div>
                            <div class="stat-label">Визитов сегодня</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${getAllVisits().filter(v => v.status === 'completed').length}</div>
                            <div class="stat-label">Всего визитов</div>
                        </div>
                    </div>
                </div>
                
                ${comment ? `
                <div class="section">
                    <h3>💬 КОММЕНТАРИЙ</h3>
                    <p>${comment}</p>
                </div>
                ` : ''}
                
                <div class="footer">
                    <p><strong>Дата формирования:</strong> ${today}</p>
                    <p><strong>Менеджер:</strong> ${currentManager.name}</p>
                    <p><strong>Email для отчетов:</strong> ${email}</p>
                    <p><strong>Система:</strong> ВЕРТУМ CRM v2.0</p>
                </div>
            </body>
            </html>
        `);
        previewWindow.document.close();
    }

    function sendEmailReport() {
        const email = document.getElementById('reportEmail')?.value || currentManager.email;
        const comment = document.getElementById('reportComment')?.value || '';
        
        if (!email) {
            showNotification('Укажите email для отправки отчета', 'warning');
            return;
        }
        
        const today = new Date().toLocaleDateString('ru-RU');
        const subject = `Отчет ВЕРТУМ CRM от ${today}`;
        
        let body = `ОТЧЕТ ВЕРТУМ CRM\n\n`;
        body += `Дата: ${today}\n`;
        body += `Менеджер: ${currentManager.name}\n\n`;
        body += `СТАТИСТИКА:\n`;
        body += `• Всего клиентов: ${allClientsData.length}\n`;
        body += `• Активных клиентов: ${allClientsData.filter(c => c.status === 'Активен').length}\n`;
        body += `• Визитов сегодня: ${getVisitsToday().filter(v => v.status === 'completed').length}\n`;
        body += `• Всего визитов: ${getAllVisits().filter(v => v.status === 'completed').length}\n\n`;
        
        if (comment) {
            body += `КОММЕНТАРИЙ:\n${comment}\n\n`;
        }
        
        body += `---\nСгенерировано в ВЕРТУМ CRM v2.0`;
        
        // Определяем email менеджера для API
        let managerEmail;
        if (currentManager.email.includes('hky@vertum.su')) {
            managerEmail = 'hky@vertum.su';
        } else {
            managerEmail = 'hrs@vertum.su';
        }

        // Отправляем через API
        fetch('/api/send-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                managerEmail: managerEmail,
                subject: subject,
                reportText: body
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showNotification('✅ Отчет успешно отправлен!', 'success');
                console.log('Отчет отправлен:', result);
                closeModal();
            } else {
                showNotification('❌ Ошибка отправки: ' + (result.message || result.error), 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка отправки:', error);
            showNotification('❌ Ошибка соединения с сервером', 'error');
        });
        showNotification(`Отчет подготовлен для отправки на ${email}`, 'info');
    }

    function generateExcelReport() {
        showNotification('Генерация отчета по Excel данным...', 'info');
        // Можно расширить функционал для детальных отчетов по Excel
    }

    // 14. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
    function callClient(clientId) {
        const client = allClientsData.find(c => c.id === clientId);
        if (!client) {
            showNotification('Клиент не найден', 'warning');
            return;
        }
        
        const modal = document.getElementById('visitModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        
        title.innerHTML = '<i class="fas fa-phone"></i> ЗВОНОК КЛИЕНТУ';
        
        content.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, #f3f0ff 0%, #e9ecef 100%); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; border: 2px solid var(--primary-color);">
                    <div style="font-size: 18px; font-weight: bold; color: var(--dark-text); margin-bottom: 5px;">
                        ${client.name}
                    </div>
                    <div style="color: #666; margin-bottom: 15px;">
                        Код: ${client.code} • ${client.region}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div><strong>Тип бизнеса:</strong> ${client.businessType}</div>
                        <div><strong>Товарная группа:</strong> ${client.productGroup}</div>
                        <div><strong>Адрес:</strong> ${client.address || 'Не указан'}</div>
                        <div><strong>Статус:</strong> ${client.status}</div>
                    </div>
                </div>
                
                ${client.phone ? `
                    <div style="background: #e8f5e9; padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--success-color); margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #2E7D32; margin-bottom: 10px;">
                            <i class="fas fa-phone-alt"></i> КОНТАКТНЫЙ ТЕЛЕФОН
                        </div>
                        <div style="font-size: 24px; color: #2E7D32; font-weight: bold; text-align: center; padding: 10px;">
                            ${client.phone}
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="tel:${client.phone.replace(/[^0-9+]/g, '')}" 
                               style="padding: 12px 25px; background: linear-gradient(135deg, var(--success-color) 0%, #2E7D32 100%); color: white; text-decoration: none; border-radius: var(--border-radius); display: inline-block; font-weight: 600; font-size: 16px;">
                                <i class="fas fa-phone"></i> Позвонить сейчас
                            </a>
                        </div>
                    </div>
                ` : `
                    <div style="background: #fff8e1; padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--warning-color); margin-bottom: 20px;">
                        <div style="color: #F57C00; text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i> Номер телефона не указан
                        </div>
                    </div>
                `}
                
                <div class="form-group">
                    <label class="form-label">Цель звонка</label>
                    <select class="form-input" id="callPurpose">
                        <option value="">Выберите цель</option>
                        <option value="confirm">Подтверждение встречи</option>
                        <option value="order">Уточнение заказа</option>
                        <option value="price">Обсуждение цен</option>
                        <option value="problem">Решение проблемы</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Заметки к звонку</label>
                    <textarea class="form-textarea" id="callNotes" placeholder="Что нужно обсудить..."></textarea>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="saveCallInfo(${clientId})" 
                        style="padding: 10px 20px; background: var(--light-bg); border: 2px solid var(--primary-color); border-radius: var(--border-radius); color: var(--primary-color); cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-save"></i> Сохранить информацию
                </button>
                <button onclick="closeModal()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 14px;">
                    Закрыть
                </button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function saveCallInfo(clientId) {
        const purpose = document.getElementById('callPurpose')?.value;
        const notes = document.getElementById('callNotes')?.value || '';
        
        if (!purpose) {
            showNotification('Укажите цель звонка', 'warning');
            return;
        }
        
        // Сохраняем информацию о звонке
        const callInfo = {
            clientId: clientId,
            purpose: purpose,
            notes: notes,
            timestamp: new Date().toISOString(),
            manager: currentManager.name
        };
        
        // Сохраняем в localStorage
        const calls = JSON.parse(localStorage.getItem('vertum_calls') || '[]');
        calls.push(callInfo);
        localStorage.setItem('vertum_calls', JSON.stringify(calls));
        
        closeModal();
        showNotification('Информация о звонке сохранена', 'info');
    }

    function editClient(clientId) {
        showNotification('Редактирование клиента', 'info');
        // Можно добавить функционал редактирования
    }

    function syncData() {
        showNotification('Синхронизация данных...', 'info');
        
        // Имитация синхронизации
        setTimeout(() => {
            loadClientsData();
            updateSystemInfo();
            showNotification('Синхронизация завершена!', 'info');
        }, 1500);
    }

    function sendReport() {
        generateReport();
    }

    // 15. УВЕДОМЛЕНИЯ
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            info: 'fa-info-circle',
            success: 'fa-check-circle',
            warning: 'fa-exclamation-triangle',
            error: 'fa-exclamation-circle'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-message">${message}</div>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Показываем уведомление
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Скрываем через 4 секунды
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // 16. МОДАЛЬНЫЕ ОКНА
    function closeModal() {
        const modal = document.getElementById('visitModal');
        modal.style.display = 'none';
        
        // Останавливаем таймер визита
        stopVisitTimer();
    }

    // Закрытие модального окна при клике вне его
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('visitModal');
        if (event.target === modal) {
            closeModal();
        }
        
        // Закрытие выпадающего списка менеджера
        const dropdown = document.getElementById('managersDropdown');
        const managerSelector = document.getElementById('currentManager');
        
        if (!managerSelector.contains(event.target) && dropdown && !dropdown.contains(event.target)) {
            dropdown.style.display = 'none';
            managerSelector.classList.remove('active');
        }
    });

    // Закрытие по ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
            
            const dropdown = document.getElementById('managersDropdown');
            if (dropdown.style.display === 'block') {
                toggleManagerDropdown();
            }
        }
    });

    // 17. СТАТИСТИКА
    function updateStatistics() {
        // Обновляем счетчик событий календаря
        const calendarEvents = document.getElementById('calendarEvents');
        if (calendarEvents) {
            calendarEvents.textContent = '3'; // Можно сделать динамическим
        }
        
        // Обновляем счетчик листов Excel
        const excelSheetsCount = document.getElementById('excelSheetsCount');
        if (excelSheetsCount) {
            excelSheetsCount.textContent = '4';
        }
    }

    // 18. СОХРАНЕНИЕ СОСТОЯНИЯ
    function saveState() {
        const state = {
            filters: {},
            currentPage: currentPage,
            currentManager: currentManager.name.includes('Хисматуллин') ? 'Хисматуллин' : 'Хитров'
        };
        
        // Сохраняем значения фильтров
        const filterIds = ['filterRegion', 'filterBusinessType', 'filterProductGroup', 
                          'filterSegmentation', 'filterDeliveryZone', 'filterDirection',
                          'filterStatus', 'filterLastVisit', 'filterManager'];
        
        filterIds.forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) {
                state.filters[filterId] = filter.value;
            }
        });
        
        localStorage.setItem('vertum_state', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('vertum_state');
        if (savedState) {
            const state = JSON.parse(savedState);
            
            // Восстанавливаем фильтры
            Object.keys(state.filters).forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter && state.filters[filterId]) {
                    filter.value = state.filters[filterId];
                }
            });
            
            // Восстанавливаем менеджера
            if (state.currentManager) {
                selectManager(state.currentManager);
            }
            
            // Применяем фильтры если они были установлены
            if (Object.values(state.filters).some(value => value)) {
                setTimeout(() => applyFilters(), 100);
            }
        }
    }

    // Загружаем состояние при инициализации
    setTimeout(loadState, 500);

    // Сохраняем состояние при разгрузке страницы
    window.addEventListener('beforeunload', saveState);

    // Сохраняем состояние каждые 30 секунд
    setInterval(saveState, 30000);

    // 19. ИНИЦИАЛИЗАЦИЯ ПОСЛЕ ЗАГРУЗКИ
    window.onload = function() {
        // Проверяем, был ли выбран менеджер ранее
        const savedManager = localStorage.getItem('vertum_current_manager');
        if (savedManager) {
            selectManager(savedManager);
        }
        
        // Инициализируем Excel секцию если она открыта
        if (window.location.hash === '#excel') {
            showSection('excelData');
        } else if (window.location.hash === '#clients') {
            showSection('clients');
        }
    };

    </script>
</body>
</html>


